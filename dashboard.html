
<!DOCTYPE html>
<!--
    Sales Tracker Dashboard with Commission Bracket System
    
    Key Features:
    - Commission brackets based on profit ranges (e.g., 10% <‚Ç±299, 15% ‚Ç±300-599, etc.)
    - Correct salary formula: Salary = (Sell Price - Buy Price) √ó Rate (%)
    - Admin restrictions: Cannot edit prices/rates (owner-controlled)
    - Real-time Firebase synchronization
    
    See COMMISSION_BRACKET_GUIDE.md and IMPLEMENTATION_SUMMARY.md for details
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#8B5CF6">
    <title>Sales Tracker Dashboard üçÑ</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #8B5CF6;
            --primary-dark: #7C3AED;
            --secondary: #EC4899;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --light: #F3E8FF;
            --dark: #581C87;
            --bg-color: #ffffff;
            --text-color: #1f2937;
            --card-bg: #ffffff;
            --border-color: #E9D5FF;
            --gradient-pink: linear-gradient(135deg, #EC4899 0%, #8B5CF6 100%);
            --gradient-purple: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%);
            --gradient-cyan: linear-gradient(135deg, #06B6D4 0%, #3B82F6 100%);
            --shadow-sm: 0 2px 8px rgba(139, 92, 246, 0.15);
            --shadow-md: 0 4px 16px rgba(139, 92, 246, 0.25);
            --shadow-lg: 0 10px 40px rgba(139, 92, 246, 0.3);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --font-family: 'Poppins', sans-serif;
            --font-heading: 'Dancing Script', cursive;
        }

        body.dark-mode {
            --bg-color: #0f172a;
            --text-color: #f1f5f9;
            --card-bg: #1e293b;
            --border-color: #334155;
            --light: #1e293b;
        }

        /* Basic Themes */
        body.theme-purple { --primary: #8B5CF6; }
        body.theme-blue { --primary: #3B82F6; }
        body.theme-green { --primary: #10B981; }
        body.theme-pink { --primary: #EC4899; }
        body.theme-orange { --primary: #F59E0B; }

        /* Community Themes */
        body.theme-cherry { 
            --primary: #FFB7C5; 
            --secondary: #FFF0F5;
            background: linear-gradient(135deg, #FFB7C5 0%, #FFF0F5 50%, #FFE4E9 100%);
        }
        
        body.theme-citrus { 
            --primary: #FF9500; 
            --secondary: #FFD60A;
            background: linear-gradient(135deg, #FF9500 0%, #FFD60A 50%, #FFF4CC 100%);
        }
        
        body.theme-lavender { 
            --primary: #B794F4; 
            --secondary: #F0E5FF;
            background: linear-gradient(135deg, #B794F4 0%, #E9D8FD 50%, #F0E5FF 100%);
        }
        
        body.theme-ocean { 
            --primary: #1E40AF; 
            --secondary: #06B6D4;
            background: linear-gradient(135deg, #1E40AF 0%, #06B6D4 50%, #67E8F9 100%);
        }
        
        body.theme-fire { 
            --primary: #EF4444; 
            --secondary: #3B82F6;
            background: linear-gradient(135deg, #EF4444 0%, #EC4899 50%, #3B82F6 100%);
        }
        
        body.theme-rainbow { 
            --primary: #EC4899;
            background: linear-gradient(135deg, #EF4444 0%, #F59E0B 16%, #10B981 33%, #3B82F6 50%, #8B5CF6 66%, #EC4899 83%, #EF4444 100%);
        }
        
        body.theme-dark { 
            --primary: #6366F1; 
            --bg-color: #0f172a;
            --text-color: #f1f5f9;
            --card-bg: #1e293b;
            --border-color: #334155;
            --light: #1e293b;
            background: linear-gradient(135deg, #020617 0%, #0f172a 50%, #1e293b 100%);
        }
        
        body.theme-sunshine { 
            --primary: #FBBF24; 
            --secondary: #FEF3C7;
            background: linear-gradient(135deg, #FBBF24 0%, #FDE68A 50%, #FEF3C7 100%);
        }
        
        body.theme-mint { 
            --primary: #10B981; 
            --secondary: #D1FAE5;
            background: linear-gradient(135deg, #10B981 0%, #6EE7B7 50%, #D1FAE5 100%);
        }
        
        body.theme-grape { 
            --primary: #A855F7; 
            --secondary: #F3E8FF;
            background: linear-gradient(135deg, #A855F7 0%, #D8B4FE 50%, #F3E8FF 100%);
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            padding: 15px;
            color: var(--text-color);
            overflow-x: hidden;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
        }

        body::before, body::after {
            position: fixed;
            font-size: 3em;
            animation: float 6s ease-in-out infinite;
            opacity: 0.3;
            z-index: 0;
            pointer-events: none;
        }

        body::before {
            content: '‚ú®';
            top: 10%;
            left: 5%;
        }

        body::after {
            content: 'üçÑ';
            top: 70%;
            right: 8%;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .top-nav {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            border: 3px solid var(--border-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 55px;
            height: 55px;
            background: var(--gradient-pink);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6em;
            color: white;
            font-weight: bold;
            box-shadow: var(--shadow-md);
            border: 4px solid var(--card-bg);
        }

        .user-details h3 {
            font-size: 1.1em;
            color: var(--primary);
            font-weight: 700;
        }

        .user-role {
            display: inline-block;
            padding: 5px 14px;
            background: var(--gradient-purple);
            color: white;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 700;
            text-transform: uppercase;
        }

        .nav-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            color: white;
        }

        .btn-theme { background: var(--gradient-cyan); }
        .btn-settings { background: var(--gradient-purple); }
        .btn-dark { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-logout { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-users { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }
        .btn-calculator { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        .btn-products { background: linear-gradient(135deg, #EC4899 0%, #8B5CF6 100%); }
        .btn-payout { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }

        .btn-small:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .app-header {
            background: var(--card-bg);
            border-radius: 30px;
            padding: 35px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-lg);
            border: 3px solid var(--border-color);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .app-icon {
            width: 85px;
            height: 85px;
            background: var(--gradient-pink);
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.2em;
            box-shadow: var(--shadow-md);
            border: 5px solid var(--card-bg);
        }

        .header-text h1 {
            font-size: 2.2em;
            font-weight: 800;
            background: var(--gradient-pink);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            font-family: var(--font-heading);
        }

        .header-text p {
            color: var(--secondary);
            font-size: 1.05em;
            font-weight: 600;
        }

        .period-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .period-tab {
            padding: 12px 24px;
            background: var(--card-bg);
            border: 3px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            font-weight: 700;
            transition: var(--transition);
            color: var(--text-color);
        }

        .period-tab.active {
            background: var(--gradient-pink);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .period-tab:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 28px;
            border-radius: 25px;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            cursor: pointer;
            border: 3px solid transparent;
        }

        .stat-card:nth-child(1) { background: linear-gradient(135deg, #FFF0F5 0%, #FFE1E8 100%); }
        .stat-card:nth-child(2) { background: linear-gradient(135deg, #F3E8FF 0%, #E9D5FF 100%); }
        .stat-card:nth-child(3) { background: linear-gradient(135deg, #E0F2FE 0%, #BAE6FD 100%); }
        .stat-card:nth-child(4) { background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%); }
        .stat-card:nth-child(5) { background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); }
        .stat-card:nth-child(6) { background: linear-gradient(135deg, #FFE4E6 0%, #FECDD3 100%); }
        .stat-card:nth-child(7) { background: linear-gradient(135deg, #D1F4E0 0%, #A7F3B8 100%); }
        .stat-card:nth-child(8) { background: linear-gradient(135deg, #E0E7FF 0%, #C7D2FE 100%); }
        .stat-card:nth-child(9) { background: linear-gradient(135deg, #FEF9C3 0%, #FDE047 100%); }

        body.dark-mode .stat-card {
            background: var(--card-bg) !important;
            border-color: var(--border-color);
        }

        .stat-card:hover {
            transform: translateY(-10px) rotate(-1deg);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            font-size: 2.8em;
            margin-bottom: 18px;
        }

        .stat-label {
            font-size: 0.85em;
            color: var(--dark);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        body.dark-mode .stat-label {
            color: var(--text-color);
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: 800;
            color: var(--primary);
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .chart-card {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            border: 3px solid var(--border-color);
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
            font-family: var(--font-heading);
        }

        .form-section {
            background: var(--card-bg);
            border-radius: 30px;
            padding: 35px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-lg);
            border: 3px solid var(--border-color);
        }

        .section-title {
            font-size: 1.6em;
            font-weight: 800;
            margin-bottom: 25px;
            color: var(--primary);
            font-family: var(--font-heading);
        }

        .form-single-column {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 0.95em;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        input, select, textarea {
            width: 100%;
            padding: 16px 20px;
            border: 3px solid var(--border-color);
            border-radius: 18px;
            font-size: 1em;
            font-family: var(--font-family);
            transition: var(--transition);
            background: var(--light);
            font-weight: 600;
            color: var(--text-color);
        }

        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background: #1e293b;
            border-color: var(--border-color);
            color: var(--text-color);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.15);
            background: var(--card-bg);
        }

        input:disabled, input:read-only {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .warranty-options {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .warranty-option {
            flex: 1;
            position: relative;
        }

        .warranty-option input[type="radio"], .warranty-option input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .warranty-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px 20px;
            background: var(--light);
            border: 3px solid var(--border-color);
            border-radius: 18px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 700;
            color: var(--text-color);
            gap: 10px;
        }

        body.dark-mode .warranty-label {
            background: #1e293b;
        }

        .warranty-option input[type="radio"]:checked + .warranty-label,
        .warranty-option input[type="checkbox"]:checked + .warranty-label {
            background: var(--gradient-pink);
            color: white;
            border-color: var(--primary);
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .warranty-label:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-sm);
        }

        .warranty-icon {
            font-size: 1.5em;
        }

        .account-type-options {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .account-type-option {
            flex: 1;
            position: relative;
        }

        .account-type-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .account-type-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px 20px;
            background: var(--light);
            border: 3px solid var(--border-color);
            border-radius: 18px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 700;
            color: var(--text-color);
            gap: 10px;
        }

        body.dark-mode .account-type-label {
            background: #1e293b;
        }

        .account-type-option input[type="radio"]:checked + .account-type-label {
            background: var(--gradient-purple);
            color: white;
            border-color: var(--primary);
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .account-type-label:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-sm);
        }

        .price-info-card {
            background: linear-gradient(135deg, #E0F2FE 0%, #BAE6FD 100%);
            padding: 20px;
            border-radius: 18px;
            border: 3px solid var(--info);
            margin-top: 15px;
            margin-bottom: 15px;
        }

        body.dark-mode .price-info-card {
            background: #1e293b;
        }

        .price-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 2px solid rgba(255,255,255,0.3);
        }

        .price-info-row:last-child {
            border-bottom: none;
        }

        .price-info-label {
            font-weight: 700;
            color: var(--text-color);
        }

        .price-info-value {
            font-weight: 800;
            color: var(--primary);
            font-size: 1.2em;
        }

        .price-info-value.highlight {
            font-size: 1.5em;
            color: var(--success);
        }

        .btn {
            padding: 18px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.05em;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            font-family: var(--font-family);
            box-shadow: var(--shadow-md);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: var(--gradient-pink);
            color: white;
        }

        .btn-primary:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-3px);
        }

        .btn-secondary {
            background: var(--gradient-purple);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
        }

        .table-section {
            background: var(--card-bg);
            border-radius: 30px;
            padding: 35px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 25px;
            border: 3px solid var(--border-color);
        }

        .table-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding-left: 55px;
        }

        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.4em;
            color: var(--primary);
            pointer-events: none;
        }

        .filter-btn {
            padding: 16px 26px;
            background: var(--light);
            border: 3px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            font-weight: 700;
            transition: var(--transition);
            font-family: var(--font-family);
            color: var(--primary);
        }

        .filter-btn:hover, .filter-btn.active {
            background: var(--gradient-pink);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 18px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.98em;
        }

        thead {
            background: var(--gradient-pink);
            color: white;
        }

        th {
            padding: 20px 18px;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        tbody tr {
            border-bottom: 2px solid var(--border-color);
            transition: var(--transition);
        }

        tbody tr:hover {
            background: var(--light);
            transform: scale(1.01);
        }

        body.dark-mode tbody tr:hover {
            background: #1e293b;
        }

        td {
            padding: 20px 18px;
            color: var(--text-color);
            font-weight: 600;
        }

        .amount-cell {
            font-weight: 800;
            color: var(--success);
            font-size: 1.2em;
        }

        .warranty-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 700;
            text-transform: uppercase;
        }

        .warranty-badge.fw {
            background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
            color: var(--success);
        }

        .warranty-badge.nw {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            color: var(--warning);
        }

        .account-type-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 700;
        }

        .account-type-badge.solo {
            background: linear-gradient(135deg, #E0F2FE 0%, #BAE6FD 100%);
            color: var(--info);
        }

        .account-type-badge.shared {
            background: linear-gradient(135deg, #FFF0F5 0%, #FFE1E8 100%);
            color: var(--secondary);
        }

        .sold-check {
            font-size: 1.5em;
            cursor: pointer;
        }

        .action-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.88em;
            font-weight: 700;
            transition: var(--transition);
            margin-right: 8px;
        }

        .edit-btn {
            background: #E0F2FE;
            color: var(--info);
        }

        .edit-btn:hover {
            background: var(--info);
            color: white;
            transform: scale(1.15);
        }

        .delete-btn {
            background: #FFE5E5;
            color: var(--danger);
        }

        .delete-btn:hover {
            background: var(--danger);
            color: white;
            transform: scale(1.15);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--secondary);
        }

        .empty-icon {
            font-size: 5em;
            margin-bottom: 20px;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .calc-display {
            grid-column: 1 / -1;
            background: var(--light);
            padding: 20px;
            border-radius: 18px;
            font-size: 2em;
            font-weight: 700;
            text-align: right;
            border: 3px solid var(--border-color);
            margin-bottom: 10px;
            color: var(--text-color);
            min-height: 70px;
        }

        body.dark-mode .calc-display {
            background: #1e293b;
        }

        .calc-btn {
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 1.3em;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            background: var(--light);
            color: var(--text-color);
            border: 3px solid var(--border-color);
        }

        body.dark-mode .calc-btn {
            background: #1e293b;
        }

        .calc-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-sm);
        }

        .calc-btn.operator {
            background: var(--gradient-purple);
            color: white;
        }

        .calc-btn.equals {
            grid-column: 3 / 5;
            background: var(--gradient-pink);
            color: white;
        }

        .calc-btn.clear {
            background: var(--gradient-cyan);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.5);
            backdrop-filter: blur(12px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 35px;
            padding: 40px;
            max-width: 750px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 70px rgba(139, 92, 246, 0.5);
            border: 4px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            color: var(--primary);
            font-size: 2em;
            font-family: var(--font-heading);
        }

        .close-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            font-size: 1.6em;
            cursor: pointer;
            color: white;
            padding: 10px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .close-btn:hover {
            transform: rotate(90deg) scale(1.15);
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 20px 32px;
            border-radius: 22px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(400px);
            transition: var(--transition);
            z-index: 1001;
            max-width: 400px;
            border: 3px solid transparent;
        }

        body.dark-mode .toast {
            background: var(--card-bg);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-icon {
            font-size: 2em;
        }

        .toast.success { 
            border-color: var(--success); 
            background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
        }
        .toast.error { 
            border-color: var(--danger); 
            background: linear-gradient(135deg, #FFE5E5 0%, #FFC1CC 100%);
        }
        .toast.info { 
            border-color: var(--info); 
            background: linear-gradient(135deg, #E0F2FE 0%, #BAE6FD 100%);
        }

        body.dark-mode .toast.success,
        body.dark-mode .toast.error,
        body.dark-mode .toast.info {
            background: var(--card-bg);
        }

        .user-list {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .user-item {
            background: var(--light);
            padding: 20px;
            border-radius: 20px;
            border: 3px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        body.dark-mode .user-item {
            background: #1e293b;
        }

        .user-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-sm);
        }
/* Profile Tracking Styles */
.product-type-toggle {
    display: flex;
    gap: 15px;
    margin-bottom: 25px;
}

.type-toggle-btn {
    flex: 1;
    padding: 15px 20px;
    background: var(--light);
    border: 3px solid var(--border-color);
    border-radius: 18px;
    cursor: pointer;
    font-weight: 700;
    transition: var(--transition);
    text-align: center;
    color: var(--text-color);
}

body.dark-mode .type-toggle-btn {
    background: #1e293b;
}

.type-toggle-btn.active {
    background: var(--gradient-pink);
    color: white;
    border-color: var(--primary);
    transform: scale(1.05);
    box-shadow: var(--shadow-md);
}

.subscription-fields {
    display: none;
    background: linear-gradient(135deg, #F3E8FF 0%, #E9D5FF 100%);
    padding: 25px;
    border-radius: 20px;
    margin-top: 20px;
    border: 3px solid var(--primary);
}

body.dark-mode .subscription-fields {
    background: #1e293b;
}

.subscription-fields.show {
    display: block;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.profile-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
    margin-top: 15px;
}

.profile-slot {
    background: var(--light);
    border: 3px solid var(--border-color);
    border-radius: 15px;
    padding: 12px;
    text-align: center;
    transition: var(--transition);
}

body.dark-mode .profile-slot {
    background: #1e293b;
}

.profile-slot.sold {
    background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
    border-color: var(--success);
}

.profile-slot.available {
    background: linear-gradient(135deg, #E0F2FE 0%, #BAE6FD 100%);
    border-color: var(--info);
}

.profile-slot-icon {
    font-size: 2em;
    margin-bottom: 5px;
}

.profile-slot-label {
    font-weight: 700;
    color: var(--text-color);
    font-size: 0.85em;
}

.profile-slot-info {
    font-size: 0.7em;
    color: var(--primary);
    margin-top: 3px;
}

.subscription-product-item {
    background: linear-gradient(135deg, #F3E8FF 0%, #E9D5FF 100%);
    border: 3px solid var(--primary);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 20px;
}

body.dark-mode .subscription-product-item {
    background: #1e293b;
}

.subscription-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.subscription-title {
    font-size: 1.4em;
    font-weight: 800;
    color: var(--primary);
}

.subscription-pricing {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.price-tag {
    background: white;
    padding: 10px 18px;
    border-radius: 15px;
    font-weight: 700;
    border: 2px solid var(--primary);
}

body.dark-mode .price-tag {
    background: #0f172a;
}

.availability-status {
    background: var(--gradient-cyan);
    color: white;
    padding: 8px 16px;
    border-radius: 12px;
    font-weight: 700;
    display: inline-block;
    margin-bottom: 15px;
}

.sale-type-select {
    display: none;
    background: linear-gradient(135deg, #FFF0F5 0%, #FFE1E8 100%);
    padding: 20px;
    border-radius: 15px;
    margin-top: 15px;
    border: 3px solid var(--secondary);
}

body.dark-mode .sale-type-select {
    background: #1e293b;
}

.sale-type-select.show {
    display: block;
}

.profile-select-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    margin-top: 15px;
}

.profile-select-btn {
    padding: 15px 10px;
    background: var(--light);
    border: 3px solid var(--border-color);
    border-radius: 12px;
    cursor: pointer;
    font-weight: 700;
    transition: var(--transition);
    text-align: center;
    color: var(--text-color);
}

body.dark-mode .profile-select-btn {
    background: #1e293b;
}

.profile-select-btn:hover:not(.disabled) {
    transform: scale(1.1);
    box-shadow: var(--shadow-sm);
}

.profile-select-btn.selected {
    background: var(--gradient-pink);
    color: white;
    border-color: var(--primary);
}

.profile-select-btn.disabled {
    opacity: 0.4;
    cursor: not-allowed;
}
        .user-item-info {
            flex: 1;
        }

        .user-item-name {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .user-item-details {
            font-size: 0.9em;
            color: var(--text-color);
            opacity: 0.8;
        }

        .user-item-actions {
            display: flex;
            gap: 8px;
        }

        .payout-list {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .payout-item {
            background: var(--light);
            padding: 20px;
            border-radius: 20px;
            border: 3px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        body.dark-mode .payout-item {
            background: #1e293b;
        }

        .payout-item.paid {
            opacity: 0.6;
        }

        .payout-info {
            flex: 1;
        }

        .payout-admin {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .payout-details {
            font-size: 0.9em;
            color: var(--text-color);
            opacity: 0.8;
        }

        .payout-amount {
            font-size: 1.5em;
            font-weight: 800;
            color: var(--success);
            margin: 0 20px;
        }

        .payout-status {
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 700;
            text-transform: uppercase;
        }

        .payout-status.pending {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            color: var(--warning);
        }

        .payout-status.paid {
            background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
            color: var(--success);
        }

        .product-list {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .product-item {
            background: var(--light);
            padding: 25px;
            border-radius: 20px;
            border: 3px solid var(--border-color);
            transition: var(--transition);
        }

        body.dark-mode .product-item {
            background: #1e293b;
        }

        .product-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .product-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .product-item-name {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--primary);
        }

        .inventory-status-badge {
            display: inline-flex;
            align-items: center;
            font-size: 0.85em;
            font-weight: 800;
            padding: 6px 14px;
            border-radius: 999px;
            border: 2px solid transparent;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .product-item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .product-detail {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 15px;
            border: 2px solid var(--border-color);
        }

        body.dark-mode .product-detail {
            background: #0f172a;
        }

        .product-detail-label {
            font-size: 0.85em;
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .product-detail-value {
            font-size: 1.1em;
            font-weight: 800;
            color: var(--success);
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
            }

            .warranty-options,
            .account-type-options {
                flex-direction: column;
            }

            .calculator-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* =================== BULK SALES STYLES =================== */
        .bulk-sales-container {
            background: var(--card-bg);
            border-radius: 30px;
            padding: 30px;
            box-shadow: var(--shadow-md);
            margin-bottom: 30px;
        }

        .bulk-sales-table {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .bulk-sales-table table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
        }

        .bulk-sales-table th {
            background: var(--primary);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 700;
            font-size: 0.9em;
        }

        .bulk-sales-table td {
            padding: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .bulk-sales-table input,
        .bulk-sales-table select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 0.9em;
            font-family: var(--font-family);
            background: var(--bg-color);
            color: var(--text-color);
        }

        .bulk-sales-table input:focus,
        .bulk-sales-table select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .bulk-row-delete {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            transition: var(--transition);
        }

        .bulk-row-delete:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .bulk-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .bulk-toggle-section {
            background: var(--light);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            border: 3px dashed var(--border-color);
        }

        .bulk-toggle-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-weight: 800;
            font-size: 1.1em;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .bulk-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .bulk-toggle-btn.active {
            background: var(--success);
        }

        @media (max-width: 768px) {
            .bulk-sales-table {
                font-size: 0.85em;
            }

            .bulk-actions {
                flex-direction: column;
            }
        }

        /* =================== PAYOUT STYLES =================== */
        .payout-item {
            background: var(--light);
            padding: 20px;
            border-radius: 20px;
            border: 3px solid var(--border-color);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .payout-item.pending {
            border-color: var(--warning);
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
        }

        .payout-item.paid {
            border-color: var(--success);
            background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
        }

        body.dark-mode .payout-item {
            background: #1e293b;
        }

        .payout-info {
            flex: 1;
        }

        .payout-admin {
            font-size: 1.2em;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .payout-details {
            font-size: 0.9em;
            opacity: 0.8;
            color: var(--text-color);
        }

        .payout-amount {
            font-size: 1.5em;
            font-weight: 800;
            color: var(--success);
        }

        .payout-breakdown {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            font-size: 0.9em;
        }

        .payout-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9em;
        }

        .payout-status.pending {
            background: var(--warning);
            color: white;
        }

        .payout-status.paid {
            background: var(--success);
            color: white;
        }

        /* Real-time Sync Status Indicator */
        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            background: var(--card-bg);
            box-shadow: var(--shadow-md);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 0.9em;
            z-index: 9999;
            transition: var(--transition);
        }

        .sync-status-icon {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .sync-status.connected .sync-status-icon {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
            animation: pulse-sync 2s infinite;
        }

        .sync-status.disconnected .sync-status-icon {
            background: var(--danger);
            box-shadow: 0 0 10px var(--danger);
        }

        .sync-status.syncing .sync-status-icon {
            background: var(--warning);
            box-shadow: 0 0 10px var(--warning);
            animation: pulse-sync 0.5s infinite;
        }

        @keyframes pulse-sync {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
        }

        .sync-status-text {
            color: var(--text-color);
        }
    </style>
</head>
<body class="theme-purple">
    <!-- Real-time Sync Status Indicator -->
    <div class="sync-status connected" id="syncStatus">
        <div class="sync-status-icon"></div>
        <span class="sync-status-text" id="syncStatusText">üîÑ Synced</span>
    </div>

    <div class="app-container">
        <!-- Top Navigation -->
        <div class="top-nav">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-details">
                    <h3 id="userName">Adeebaabkhan</h3>
                    <p><span class="user-role" id="userRole">üëë OWNER</span></p>
                </div>
            </div>
            <div class="nav-actions">
                <button class="btn-small btn-users" id="btnUsers" style="display: none;">üë• Manage Admins</button>
                <button class="btn-small btn-products" id="btnProducts" style="display: none;">üì¶ Manage Products</button>
                <button class="btn-small btn-payout" id="btnPayout" style="display: none;">üí∞ Payouts</button>
                <button class="btn-small btn-calculator" id="btnCalculator">üßÆ Calculator</button>
                <button class="btn-small btn-theme" id="btnTheme">üé® Theme</button>
                <button class="btn-small btn-settings" id="btnSettings">‚öôÔ∏è Settings</button>
                <button class="btn-small btn-dark" id="btnDark">üåô Dark</button>
                <button class="btn-small btn-logout" id="btnLogout">üö™ Logout</button>
            </div>
        </div>

        <!-- App Header -->
        <div class="app-header">
            <div class="header-content">
                <div class="app-icon">üçÑ</div>
                <div class="header-text">
                    <h1>Sales Tracker Dashboard</h1>
                    <p id="dashboardSubtitle">üëë Owner Dashboard - Track All Sales & Admins</p>
                </div>
            </div>
        </div>

        <!-- Period Tabs -->
        <div class="period-tabs">
            <div class="period-tab active" data-period="all">üìä All Time</div>
            <div class="period-tab" data-period="today">üìÖ Today</div>
            <div class="period-tab" data-period="week">üìÜ This Week</div>
            <div class="period-tab" data-period="month">üóìÔ∏è This Month</div>
        </div>

        <!-- Dashboard Stats -->
        <div class="dashboard">
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-label">Total Sales</div>
                <div class="stat-value" id="totalSales">‚Ç±0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üíµ</div>
                <div class="stat-label">Total Capital</div>
                <div class="stat-value" id="totalCapital">‚Ç±0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üéØ</div>
                <div class="stat-label">Total Profit</div>
                <div class="stat-value" id="totalProfit">‚Ç±0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-label">Total Salary</div>
                <div class="stat-value" id="totalSalary">‚Ç±0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üì¶</div>
                <div class="stat-label">Total Products</div>
                <div class="stat-value" id="totalProducts">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-label">Items Sold</div>
                <div class="stat-value" id="soldCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìà</div>
                <div class="stat-label">Avg Sale Value</div>
                <div class="stat-value" id="avgSaleValue">‚Ç±0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-label">Admins</div>
                <div class="stat-value" id="adminCount">0</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-section">
            <div class="chart-card">
                <div class="chart-title">üìä Sales Overview</div>
                <canvas id="salesChart"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-title">üí∞ Revenue Breakdown</div>
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

        <!-- Add Sale Form -->
        <div class="form-section">
            <h2 class="section-title">‚ûï Add New Sale</h2>
            <form id="addSaleForm" class="form-single-column">
                <!-- Product Selection -->
                <div class="form-group">
                    <label>üì¶ Select Product</label>
                    <select id="productSelect" required>
                        <option value="">-- Select Product --</option>
                    </select>
                </div>

                <!-- Product Details Card (Hidden until product selected) -->
                <div id="productDetailsCard" class="price-info-card" style="display: none;">
                    <div class="price-info-row">
                        <span class="price-info-label">üíµ Your Price</span>
                        <span class="price-info-value" id="productPrice">‚Ç±0</span>
                    </div>
                    <div class="price-info-row">
                        <span class="price-info-label">üìä Margin</span>
                        <span class="price-info-value" id="productMargin">0%</span>
                    </div>
                    <div class="price-info-row">
                        <span class="price-info-label">üéØ Your Commission</span>
                        <span class="price-info-value highlight" id="productCommission">‚Ç±0</span>
                    </div>
                </div>

                <!-- Profile Tracking Fields (for streaming services) -->
                <div id="profileTrackingFields" style="display: none;">
                    <!-- Account ID -->
                    <div class="form-group">
                        <label>üé¨ Account ID</label>
                        <select id="accountIdSelect">
                            <option value="">-- Select Account --</option>
                        </select>
                    </div>

                    <!-- Profile Number -->
                    <div class="form-group">
                        <label>üî¢ Profile Number</label>
                        <select id="profileNumberSelect" onchange="updateProfileStatus()">
                            <option value="">-- Select Profile --</option>
                            <option value="1">Profile 1</option>
                            <option value="2">Profile 2</option>
                            <option value="3">Profile 3</option>
                            <option value="4">Profile 4</option>
                            <option value="5">Profile 5</option>
                        </select>
                    </div>

                    <!-- Profile Status Display -->
                    <div id="profileStatusDisplay" class="price-info-card" style="display: none; background: linear-gradient(135deg, #FFF0F5 0%, #FFE1E8 100%);">
                        <div class="price-info-row">
                            <span class="price-info-label">üìä Profile Status</span>
                            <span class="price-info-value" id="profileStatusText">Loading...</span>
                        </div>
                        <div id="profileSlotDetails" style="margin-top: 10px; font-size: 0.9em; color: var(--text-color);"></div>
                    </div>

                    <!-- Profile Name (OPTIONAL) -->
                    <div class="form-group">
                        <label>üë§ Profile Name (Optional)</label>
                        <input type="text" id="profileNameInput" placeholder="e.g., John's Profile (optional - can leave blank)">
                        <small style="color: var(--text-color); opacity: 0.7; margin-top: 5px; display: block;">You can leave this blank</small>
                    </div>

                    <!-- Profile Type -->
                    <div class="form-group">
                        <label>üìã Profile Type</label>
                        <div class="account-type-options">
                            <div class="account-type-option">
                                <input type="radio" id="profileTypeSolo" name="profileType" value="Solo">
                                <label for="profileTypeSolo" class="account-type-label">
                                    <span>üë§</span>
                                    <span>Solo (1 user)</span>
                                </label>
                            </div>
                            <div class="account-type-option">
                                <input type="radio" id="profileTypeShared" name="profileType" value="Shared">
                                <label for="profileTypeShared" class="account-type-label">
                                    <span>üë•</span>
                                    <span>Shared (2 users)</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Sold By -->
                    <div class="form-group">
                        <label>üéØ Sold By</label>
                        <select id="soldBySelect">
                            <option value="">-- Select Admin --</option>
                        </select>
                    </div>
                </div>
<div class="form-group">
  <label>Buyer Username</label>
  <input type="text" id="buyerUsernameInput" placeholder="Enter buyer's username">
</div>

<!-- Sold Account Email -->
<div class="form-group">
  <label>Sold Account Email</label>
  <input type="email" id="accountEmailInput" placeholder="Enter sold account's email">
</div>
                <!-- Warranty -->
                <div class="form-group">
                    <label>üõ°Ô∏è Warranty Type</label>
                    <div class="warranty-options">
                        <div class="warranty-option">
                            <input type="radio" id="warrantyFW" name="warranty" value="FW" required>
                            <label for="warrantyFW" class="warranty-label">
                                <span class="warranty-icon">‚úÖ</span>
                                <span>Full Warranty</span>
                            </label>
                        </div>
                        <div class="warranty-option">
                            <input type="radio" id="warrantyNW" name="warranty" value="NW">
                            <label for="warrantyNW" class="warranty-label">
                                <span class="warranty-icon">‚ö†Ô∏è</span>
                                <span>No Warranty</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Account Type -->
                <div class="form-group">
                    <label>üë§ Account Type</label>
                    <div class="account-type-options">
                        <div class="account-type-option">
                            <input type="radio" id="accountSolo" name="accountType" value="Solo" required>
                            <label for="accountSolo" class="account-type-label">
                                <span>üë§</span>
                                <span>Solo</span>
                            </label>
                        </div>
                        <div class="account-type-option">
                            <input type="radio" id="accountShared" name="accountType" value="Shared">
                            <label for="accountShared" class="account-type-label">
                                <span>üë•</span>
                                <span>Shared</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Quantity -->
                <div class="form-group">
                    <label>üî¢ Quantity</label>
                    <input type="number" id="productQuantity" placeholder="Enter quantity" min="1" value="1" required>
                </div>

                <!-- TOTAL EARNINGS CARD (Updates with quantity) -->
                <div id="totalEarningsCard" class="price-info-card" style="display: none; background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%); border-color: var(--success);">
                    <div class="price-info-row">
                        <span class="price-info-label">üíµ Total Price</span>
                        <span class="price-info-value" id="totalPrice">‚Ç±0</span>
                    </div>
                    <div class="price-info-row">
                        <span class="price-info-label">üéØ Total Earnings</span>
                        <span class="price-info-value highlight" id="totalEarnings">‚Ç±0</span>
                    </div>
                </div>
<!-- Sale Type Selection (for subscription products) -->
<div id="saleTypeSelection" class="sale-type-select">
    <h4 style="color: var(--secondary); margin-bottom: 15px; font-weight: 800;">Choose Sale Type</h4>
    
    <div class="warranty-options">
        <div class="warranty-option">
            <input type="radio" id="saleTypeFull" name="saleType" value="full" checked>
            <label for="saleTypeFull" class="warranty-label">
                <span class="warranty-icon">üì¶</span>
                <span>Full Account</span>
            </label>
        </div>
        <div class="warranty-option">
            <input type="radio" id="saleTypeProfile" name="saleType" value="profile">
            <label for="saleTypeProfile" class="warranty-label">
                <span class="warranty-icon">üë§</span>
                <span>Individual Profile</span>
            </label>
        </div>
    </div>

    <!-- Profile Selection -->
    <div id="profileSelection" style="display: none; margin-top: 20px;">
        <label style="display: block; font-weight: 700; color: var(--primary); margin-bottom: 10px;">
            Select Profile Number:
        </label>
        <div id="profileSelectGrid" class="profile-select-grid"></div>
    </div>
</div>
                    <div class="form-group" style="display: none;">

                    <label>üì¶ Status</label>
                    <input type="hidden" id="productSoldStatus" value="yes">
                </div>

                <button type="submit" class="btn btn-primary">‚ûï ADD SALE</button>
            </form>
        </div>

       <!-- Bulk Add Sales Section -->
        <div class="bulk-sales-container" id="bulkSalesSection">
            <div class="bulk-toggle-section">
                <h2 class="section-title">‚ö° Bulk Add Sales (Fast Entry)</h2>
                <p style="margin-bottom: 15px; opacity: 0.8;">Add multiple sales at once to save time!</p>
                <button class="bulk-toggle-btn" id="toggleBulkSales" onclick="toggleBulkSales()">
                    üìã Show Bulk Entry
                </button>
            </div>

            <div id="bulkSalesForm" style="display: none;">
                <div class="bulk-sales-table">
                    <table>
                        <thead>
                            <tr>
                                <th style="min-width: 180px;">üì¶ Product</th>
                                <th style="min-width: 120px;">üë§ Account Type</th>
                                <th style="min-width: 100px;">üõ°Ô∏è Warranty</th>
                                <th style="min-width: 100px;">üíµ Buy (‚Ç±)</th>
                                <th style="min-width: 100px;">üí∞ Sell (‚Ç±)</th>
                                <th style="min-width: 80px;">üî¢ Qty</th>
                                <th style="min-width: 100px;">üì¶ Status</th>
                                <th style="min-width: 80px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bulkSalesTableBody">
                            <!-- Bulk rows will be added here -->
                        </tbody>
                    </table>
                </div>

                <div class="bulk-actions">
                    <button class="btn btn-secondary" onclick="addBulkRow()">‚ûï Add Row</button>
                    <button class="btn btn-success" onclick="saveBulkSales()">üíæ Save All Sales</button>
                    <button class="btn btn-info" onclick="applyToAllWarranty()">üõ°Ô∏è Apply Warranty to All</button>
                    <button class="btn btn-info" onclick="applyToAllAccountType()">üë§ Apply Account Type to All</button>
                    <button class="btn btn-info" onclick="applyToAllStatus()">üì¶ Apply Status to All</button>
                    <span id="bulkRowCount" style="font-weight: 700; color: var(--primary);">0 rows</span>
                </div>
            </div>
        </div>

        <!-- Sales Table -->
        <div class="table-section">
            <h2 class="section-title">üìã Sales Records</h2>
            
            <div class="table-controls">
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="searchInput" placeholder="Search sales...">
                </div>
                <select id="userFilter" style="padding: 16px; border-radius: 20px; border: 3px solid var(--border-color); background: var(--light); color: var(--text-color); font-weight: 700;">
                    <option value="all">All Admins</option>
                </select>
                <button class="filter-btn active" id="filterAll">üìä All</button>
                <button class="filter-btn" id="filterSold">‚úÖ Sold</button>
                <button class="filter-btn" id="filterStock">üì¶ In Stock</button>
                <button class="btn-small btn-success" id="btnExport">üì• Export CSV</button>
                <button class="btn-small btn-danger" id="btnClearAll">üóëÔ∏è Clear All</button>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th id="adminColumn">Admin</th>
                            <th>Product</th>
                            <th>Buyer Username</th>
                            <th>Account Email</th>
                            <th>Account</th>
                            <th>Profile</th>
                            <th>Slot</th>
                            <th>Profile Name</th>
                            <th>Sold By</th>
                            <th>Warranty</th>
                            <th>Type</th>
                            <th>Qty</th>
                            <th>Price</th>
                            <th>Total</th>
                            <th>Sold</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody">
                        <tr>
                            <td colspan="17">
                                <div class="empty-state">
                                    <div class="empty-icon">üì¶</div>
                                    <h3>No sales yet</h3>
                                    <p>Add your first sale to get started!</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Inventory Dashboard Section (Owner Only) -->
    <div id="inventoryDashboardSection" class="table-section" style="display: none;">
        <h2 class="section-title">üì¶ Inventory Dashboard</h2>
        <p style="margin-bottom: 20px; opacity: 0.8;">Track all accounts with their profile and slot status</p>
        
        <div style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="openAccountManagementModal()">‚ûï Create New Account</button>
        </div>
        
        <div id="accountsList" class="product-list">
            <!-- Accounts will be rendered here -->
        </div>
    </div>

    <!-- Account Management Modal -->
    <div class="modal" id="accountManagementModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>üé¨ Create Account</h2>
                <button class="close-btn" onclick="closeAccountManagementModal()">‚úï</button>
            </div>

            <form id="createAccountForm" class="form-single-column" onsubmit="saveAccount(event)">
                <div class="form-group">
                    <label>üé¨ Account ID</label>
                    <input type="text" id="accountIdInput" placeholder="e.g., NETF-1234" required>
                </div>

                <div class="form-group">
                    <label>üì¶ Status</label>
                    <select id="accountStatus" required>
                        <option value="stock" selected>Stock</option>
                        <option value="sold">Sold</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>üì¶ Product</label>
                    <select id="accountProductSelect" required>
                        <option value="">-- Select Product --</option>
                        <option value="Netflix">Netflix</option>
                        <option value="Disney+">Disney+</option>
                        <option value="HBO">HBO</option>
                        <option value="YouTube Premium">YouTube Premium</option>
                        <option value="Prime Video">Prime Video</option>
                        <option value="Apple TV+">Apple TV+</option>
                        <option value="Paramount+">Paramount+</option>
                        <option value="Discovery+">Discovery+</option>
                        <option value="Crunchyroll">Crunchyroll</option>
                        <option value="VIU">VIU</option>
                        <option value="WeTV">WeTV</option>
                        <option value="Vimeo">Vimeo</option>
                        <option value="iQIYI">iQIYI</option>
                        <option value="Loklok">Loklok</option>
                        <option value="iWant">iWant</option>
                        <option value="Vivaone">Vivaone</option>
                        <option value="Vivamax">Vivamax</option>
                        <option value="Vivabundle">Vivabundle</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>üî¢ Total Profiles</label>
                    <input type="number" id="accountProfilesInput" min="1" max="10" value="5" required>
                </div>
                
                <div class="form-group">
                    <label>üìã Profile Type</label>
                    <div class="account-type-options">
                        <div class="account-type-option">
                            <input type="radio" id="accountTypeSolo" name="accountProfileType" value="solo" required>
                            <label for="accountTypeSolo" class="account-type-label">
                                <span>üë§</span>
                                <span>Solo (1 user per profile)</span>
                            </label>
                        </div>
                        <div class="account-type-option">
                            <input type="radio" id="accountTypeShared" name="accountProfileType" value="shared" checked>
                            <label for="accountTypeShared" class="account-type-label">
                                <span>üë•</span>
                                <span>Shared (2 users per profile)</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-success">‚úÖ Create Account</button>
            </form>
        </div>
    </div>

    <!-- Product Management Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì¶ Manage Products</h2>
                <button class="close-btn" onclick="closeProductModal()">‚úï</button>
            </div>
            
            <div class="form-section" style="border: none; box-shadow: none; padding: 0;">
                <!-- Product Type Toggle -->
<div class="form-section" style="border: none; box-shadow: none; padding: 0;">
    <h3 class="section-title">üéØ Product Type</h3>
    <div class="product-type-toggle">
        <div class="type-toggle-btn active" id="regularProductBtn" onclick="switchProductType('regular')">
            üì¶ Regular Product
        </div>
        <div class="type-toggle-btn" id="subscriptionProductBtn" onclick="switchProductType('subscription')">
            üé¨ Subscription with Profiles
        </div>
    </div>
</div>

<!-- Subscription Product Form -->
<div id="subscriptionFields" class="subscription-fields">
    <h4 style="color: var(--primary); margin-bottom: 15px; font-weight: 800;">üì∫ Subscription Product Setup</h4>
    <form id="addSubscriptionForm">
        <div class="form-group">
            <label>üì¶ Product Name</label>
            <select id="subProductNameSelect" onchange="handleSubProductNameSelect()" required>
                <option value="">-- Select --</option>
                <optgroup label="üé¨ Streaming">
                    <option value="Netflix">Netflix</option>
                    <option value="Disney+">Disney+</option>
                    <option value="HBO Max">HBO Max</option>
                    <option value="Prime Video">Prime Video</option>
                    <option value="Apple TV+">Apple TV+</option>
                    <option value="Paramount+">Paramount+</option>
                    <option value="Discovery+">Discovery+</option>
                    <option value="Crunchyroll">Crunchyroll</option>
                </optgroup>
                <optgroup label="üéµ Music">
                    <option value="Spotify">Spotify</option>
                    <option value="Apple Music">Apple Music</option>
                    <option value="YouTube Premium">YouTube Premium</option>
                </optgroup>
                <optgroup label="üé® Creative">
                    <option value="Canva Pro">Canva Pro</option>
                    <option value="Adobe Creative Cloud">Adobe Creative Cloud</option>
                </optgroup>
                <option value="custom">‚ûï Custom...</option>
            </select>
            <input type="text" id="subProductName" placeholder="Enter custom name" style="display: none; margin-top: 10px;">
        </div>

        <div class="form-group">
            <label>üõí Buy Price (Your Cost)</label>
            <input type="number" id="subBuyPrice" placeholder="e.g., 250" step="0.01" min="0" required>
        </div>

        <div class="form-group">
            <label>üí∞ Full Account Sell Price</label>
            <input type="number" id="subFullPrice" placeholder="e.g., 300" step="0.01" min="0" required>
        </div>

        <div class="form-group">
            <label>üë• Number of Profiles/Slots</label>
            <input type="number" id="subTotalProfiles" placeholder="e.g., 5" min="1" max="20" required>
        </div>

<div class="form-group">
    <label>üë§ Solo Profile Price (Per Individual Profile)</label>
    <input type="number" id="subSoloPrice" placeholder="e.g., 50" step="0.01" min="0" required>
</div>

<div class="form-group">
    <label>üë• Shared Full Account Price (All Profiles)</label>
    <input type="number" id="subSharedPrice" placeholder="e.g., 200" step="0.01" min="0" required>
</div>

        <button type="submit" class="btn btn-success">‚ûï ADD SUBSCRIPTION PRODUCT</button>
    </form>
</div>
                <h3 class="section-title">‚ûï Add New Product</h3>
                <form id="addProductForm" class="form-single-column">
                    <div class="form-group">
                        <label>üì¶ Product Name</label>
                        <select id="productNameSelect" onchange="handleProductNameSelect()" required>
                            <option value="">-- Select or Add Custom --</option>
                            <optgroup label="üé¨ Streaming Services">
                                <option value="Netflix">Netflix</option>
                                <option value="Disney+">Disney+</option>
                                <option value="HBO">HBO</option>
                                <option value="YouTube Premium">YouTube Premium</option>
                                <option value="Prime Video">Prime Video</option>
                                <option value="Apple TV+">Apple TV+</option>
                                <option value="Paramount+">Paramount+</option>
                                <option value="Discovery+">Discovery+</option>
                                <option value="Crunchyroll">Crunchyroll</option>
                                <option value="VIU">VIU</option>
                                <option value="WeTV">WeTV</option>
                                <option value="Vimeo">Vimeo</option>
                                <option value="iQIYI">iQIYI</option>
                                <option value="Loklok">Loklok</option>
                                <option value="iWant">iWant</option>
                            </optgroup>
                            <optgroup label="üéµ Music Streaming">
                                <option value="Spotify">Spotify</option>
                                <option value="Apple Music">Apple Music</option>
                            </optgroup>
                            <optgroup label="üé® Creative Tools">
                                <option value="Canva">Canva</option>
                                <option value="Adobe Creative Cloud">Adobe Creative Cloud</option>
                            </optgroup>
                            <optgroup label="ü§ñ AI & Productivity">
                                <option value="ChatGPT">ChatGPT</option>
                                <option value="Grammarly">Grammarly</option>
                                <option value="Quillbot">Quillbot</option>
                                <option value="Notion">Notion</option>
                                <option value="Evernote">Evernote</option>
                                <option value="Microsoft 365">Microsoft 365</option>
                            </optgroup>
                            <optgroup label="üì± Mobile Apps">
                                <option value="Remini">Remini</option>
                                <option value="CapCut">CapCut</option>
                            </optgroup>
                            <optgroup label="üáµüá≠ Philippines">
                                <option value="Vivaone">Vivaone</option>
                                <option value="Vivamax">Vivamax</option>
                                <option value="Vivabundle">Vivabundle</option>
                            </optgroup>
                            <optgroup label="üíº Professional">
                                <option value="LinkedIn Premium">LinkedIn Premium</option>
                                <option value="Dropbox">Dropbox</option>
                            </optgroup>
                             <optgroup label="üßò Wellness">
                                <option value="Calm">Calm</option>
                                <option value="Headspace">Headspace</option>
                            </optgroup>
                            <optgroup label="üìö Education">
                                <option value="Duolingo">Duolingo</option>
                            </optgroup>
                            <option value="custom">‚ûï Custom Product...</option>
                        </select>
                        <input type="text" id="newProductName" placeholder="Enter custom product name" style="display: none; margin-top: 10px;">
                    </div>
                    
                    <div class="form-group">
                        <label>üõí Buy Price (Your Cost)</label>
                        <input type="number" id="newBuyPrice" placeholder="e.g., 100" step="0.01" min="0" required oninput="autoCalculatePrices()">
                    </div>
                    
                    <div class="form-group">
                        <label>üí∞ Sell Price (Customer Price)</label>
                        <input type="number" id="newSellPrice" placeholder="e.g., 150" step="0.01" min="0" required oninput="autoCalculatePrices()">
                    </div>
                    
                    <div class="form-group">
                        <label>üìä Margin %</label>
                        <input type="number" id="newMargin" placeholder="Auto-calculated" step="0.01" readonly>
                    </div>

                    <!-- Auto-calculated info display -->
                    <div id="productCalculation" class="price-info-card" style="display: none;">
                        <div class="price-info-row">
                            <span class="price-info-label">üí∞ Total Profit</span>
                            <span class="price-info-value highlight" id="autoProfit">‚Ç±0</span>
                        </div>
                        <div class="price-info-row">
                            <span class="price-info-label">üìä Profit Margin</span>
                            <span class="price-info-value" id="autoProfitPercent">0%</span>
                        </div>
                        <div id="adminCommissionsList" style="margin-top: 10px;">
                            <!-- Real admin commissions will be dynamically inserted here -->
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success">‚ûï ADD PRODUCT</button>
                </form>
            </div>

<!-- Product Search/Filter -->
<div style="margin: 20px 0; padding: 15px; background: var(--light); border-radius: 20px; border: 2px solid var(--border-color);">
    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
            <input type="text" id="productSearch" placeholder="üîç Search products..." 
                   style="width: 100%; padding: 12px; border-radius: 10px; border: 2px solid var(--border-color);"
                   onkeyup="filterProducts()">
        </div>
        <button class="btn btn-info" onclick="filterProducts('all')">üìä All</button>
        <button class="btn btn-secondary" onclick="sortProducts('name')">üî§ Sort by Name</button>
        <button class="btn btn-secondary" onclick="sortProducts('price')">üí∞ Sort by Price</button>
    </div>
</div>

<div class="product-list" id="productList"></div>
<div class="section-title" style="margin-top: 30px;">üé¨ Subscription Products</div>
<div id="subscriptionProductList" class="product-list"></div>
            
        </div>
    </div>

    <!-- Calculator Modal -->
    <div class="modal" id="calculatorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üßÆ Calculator</h2>
                <button class="close-btn" onclick="closeCalculatorModal()">‚úï</button>
            </div>
            
            <div class="calc-display" id="calcDisplay">0</div>
            
            <div class="calculator-grid">
                <button class="calc-btn clear" onclick="clearCalc()">C</button>
                <button class="calc-btn operator" onclick="appendCalc('/')">/</button>
                <button class="calc-btn operator" onclick="appendCalc('*')">√ó</button>
                <button class="calc-btn operator" onclick="deleteCalc()">‚Üê</button>
                
                <button class="calc-btn" onclick="appendCalc('7')">7</button>
                <button class="calc-btn" onclick="appendCalc('8')">8</button>
                <button class="calc-btn" onclick="appendCalc('9')">9</button>
                <button class="calc-btn operator" onclick="appendCalc('-')">-</button>
                
                <button class="calc-btn" onclick="appendCalc('4')">4</button>
                <button class="calc-btn" onclick="appendCalc('5')">5</button>
                <button class="calc-btn" onclick="appendCalc('6')">6</button>
                <button class="calc-btn operator" onclick="appendCalc('+')">+</button>
                
                <button class="calc-btn" onclick="appendCalc('1')">1</button>
                <button class="calc-btn" onclick="appendCalc('2')">2</button>
                <button class="calc-btn" onclick="appendCalc('3')">3</button>
                <button class="calc-btn equals" onclick="calculateCalc()">=</button>
                
                <button class="calc-btn" onclick="appendCalc('0')" style="grid-column: 1 / 3;">0</button>
                <button class="calc-btn" onclick="appendCalc('.')">.</button>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üë• Manage Admins</h2>
                <button class="close-btn" onclick="closeUserModal()">‚úï</button>
            </div>
            
            <div class="form-section" style="border: none; box-shadow: none; padding: 0;">
                <h3 class="section-title">‚ûï Add New Admin</h3>
                <form id="addUserForm" class="form-single-column">
                    <div class="form-group">
                        <label>üë§ Custom Name</label>
                        <input type="text" id="newUserName" placeholder="e.g., Sarah, Mike, Team A" required>
                    </div>
                    
                    <!-- ‚úÖ FIXED: Added Missing Username Field -->
                    <div class="form-group">
                        <label>üîë Username</label>
                        <input type="text" id="newUsername" placeholder="e.g., sarah123, mike_sales" required>
                        <small style="color: var(--text-color); opacity: 0.7; display: block; margin-top: 5px;">
                            üí° Used for login - must be unique
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>üîí Password</label>
                        <input type="password" id="newPassword" placeholder="Password" required>
                    </div>
                    <div class="form-group">
                        <label>üìä Commission System</label>
                        <div class="account-type-options">
                            <div class="account-type-option">
                                <input type="radio" id="commissionFlatRate" name="commissionMode" value="flatRate" checked>
                                <label for="commissionFlatRate" class="account-type-label">
                                    <span class="warranty-icon">üíµ</span>
                                    <span>Flat Rate</span>
                                </label>
                            </div>
                            <div class="account-type-option">
                                <input type="radio" id="commissionBracket" name="commissionMode" value="bracket">
                                <label for="commissionBracket" class="account-type-label">
                                    <span class="warranty-icon">üìä</span>
                                    <span>Bracket-Based</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" id="flatRateSection">
                        <label>üí∞ Flat Commission Rate (%)</label>
                        <input type="number" id="newProfitPercent" placeholder="e.g., 20 or 30" min="0" max="100" value="20">
                        <small style="color: var(--text-color); opacity: 0.7; display: block; margin-top: 5px;">
                            üí° Admin will earn this fixed % from each sale's profit
                        </small>
                    </div>
                    
                    <div class="form-group" id="bracketInfoSection" style="display: none;">
                        <div style="background: var(--light); padding: 15px; border-radius: 15px; border: 3px solid var(--border-color);">
                            <strong style="color: var(--primary);">üìä Bracket-Based System</strong>
                            <p style="margin-top: 8px; color: var(--text-color); opacity: 0.8; font-size: 0.9em;">
                                Commission rate will be determined automatically based on profit ranges configured below.
                            </p>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success">‚ûï Add Admin</button>
                </form>
            </div>

            <!-- Commission Bracket Configuration -->
            <div class="section-title" style="margin-top: 30px;">üìä Commission Bracket System</div>
            <div class="form-section" style="border: none; box-shadow: none; padding: 0;">
                <p style="margin-bottom: 15px; color: var(--text-color); opacity: 0.8;">
                    üí° Set commission rates based on profit ranges. Higher profits = higher commission rates.
                </p>
                
                <div id="commissionBracketsList" style="margin-bottom: 15px;">
                    <!-- Brackets will be dynamically rendered here -->
                </div>
                
                <button class="btn btn-info" onclick="openAddBracketModal()" style="width: auto; padding: 10px 20px;">
                    ‚ûï Add Bracket
                </button>
            </div>

            <div class="section-title" style="margin-top: 30px;">üìã Admin List</div>
            <div class="user-list" id="userList"></div>

            <div class="section-title" style="margin-top: 30px;">üí∞ Payout Dashboard</div>
            
            <!-- Payout Period Filter -->
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="filter-btn active" id="payoutPeriodAll" onclick="setPayoutPeriod('all')">üìä All Time</button>
                <button class="filter-btn" id="payoutPeriodWeek" onclick="setPayoutPeriod('week')">üìÖ This Week</button>
                <button class="filter-btn" id="payoutPeriodMonth" onclick="setPayoutPeriod('month')">üìÜ This Month</button>
                <button class="btn btn-info" onclick="openPayoutHistory()">üìú View History</button>
            </div>

            <div class="payout-list" id="payoutList"></div>
        </div>
    </div>

    <!-- Commission Bracket Modal -->
    <div class="modal" id="commissionBracketModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä Add Commission Bracket</h2>
                <button class="close-btn" onclick="closeCommissionBracketModal()">‚úï</button>
            </div>
            
            <form id="addBracketForm">
                <div class="form-group">
                    <label>üíµ Minimum Profit (‚Ç±)</label>
                    <input type="number" id="bracketMinProfit" placeholder="e.g., 0, 300, 600" min="0" step="0.01" required>
                    <small style="color: var(--text-color); opacity: 0.7; display: block; margin-top: 5px;">
                        üí° Starting profit amount for this bracket
                    </small>
                </div>
                
                <div class="form-group">
                    <label>üíµ Maximum Profit (‚Ç±)</label>
                    <input type="number" id="bracketMaxProfit" placeholder="e.g., 299.99, 599.99, 999.99" min="0" step="0.01">
                    <small style="color: var(--text-color); opacity: 0.7; display: block; margin-top: 5px;">
                        üí° Leave empty for "and above" (e.g., ‚Ç±1000+)
                    </small>
                </div>
                
                <div class="form-group">
                    <label>üìä Commission Rate (%)</label>
                    <input type="number" id="bracketRate" placeholder="e.g., 10, 15, 20" min="0" max="100" step="0.1" required>
                    <small style="color: var(--text-color); opacity: 0.7; display: block; margin-top: 5px;">
                        üí° Commission percentage for this profit range
                    </small>
                </div>
                
                <button type="submit" class="btn btn-success">‚ûï Add Bracket</button>
            </form>
        </div>
    </div>

    <!-- Edit Commission Settings Modal -->
    <div class="modal" id="editCommissionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Edit Commission Settings</h2>
                <button class="close-btn" onclick="closeEditCommissionModal()">‚úï</button>
            </div>
            
            <form id="editCommissionForm">
                <input type="hidden" id="editUserId">
                
                <div class="form-group">
                    <label>üë§ Admin Name</label>
                    <input type="text" id="editUserName" disabled style="opacity: 0.7;">
                </div>
                
                <div class="form-group">
                    <label>üìä Commission System</label>
                    <div class="account-type-options">
                        <div class="account-type-option">
                            <input type="radio" id="editCommissionFlatRate" name="editCommissionMode" value="flatRate">
                            <label for="editCommissionFlatRate" class="account-type-label">
                                <span class="warranty-icon">üíµ</span>
                                <span>Flat Rate</span>
                            </label>
                        </div>
                        <div class="account-type-option">
                            <input type="radio" id="editCommissionBracket" name="editCommissionMode" value="bracket">
                            <label for="editCommissionBracket" class="account-type-label">
                                <span class="warranty-icon">üìä</span>
                                <span>Bracket-Based</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" id="editFlatRateSection">
                    <label>üí∞ Flat Commission Rate (%)</label>
                    <input type="number" id="editProfitPercent" placeholder="e.g., 20 or 30" min="0" max="100" step="0.1">
                    <small style="color: var(--text-color); opacity: 0.7; display: block; margin-top: 5px;">
                        üí° Admin will earn this fixed % from each sale's profit
                    </small>
                </div>
                
                <div class="form-group" id="editBracketInfoSection" style="display: none;">
                    <div style="background: var(--light); padding: 15px; border-radius: 15px; border: 3px solid var(--border-color);">
                        <strong style="color: var(--primary);">üìä Bracket-Based System</strong>
                        <p style="margin-top: 8px; color: var(--text-color); opacity: 0.8; font-size: 0.9em;">
                            Commission rate will be determined automatically based on profit ranges configured in the Commission Bracket System section.
                        </p>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">üíæ Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditCommissionModal()" style="flex: 1;">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payout History Modal -->
    <div class="modal" id="payoutHistoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìú Payout History</h2>
                <button class="close-btn" onclick="closePayoutHistory()">‚úï</button>
            </div>
            
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Admin</th>
                            <th>Period</th>
                            <th>Amount</th>
                            <th>Method</th>
                            <th>Reference</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="payoutHistoryBody">
                        <tr>
                            <td colspan="7">
                                <div class="empty-state">
                                    <div class="empty-icon">üìú</div>
                                    <p>No payout history yet</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Mark as Paid Modal -->
    <div class="modal" id="markPaidModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>üí∞ Mark Payout as Paid</h2>
                <button class="close-btn" onclick="closeMarkPaidModal()">‚úï</button>
            </div>
            
            <form id="markPaidForm" onsubmit="confirmMarkAsPaid(event)">
                <input type="hidden" id="payoutToMarkId">
                <input type="hidden" id="payoutToMarkUserId">
                <input type="hidden" id="payoutToMarkAmount">
                
                <div class="form-group">
                    <label>üí≥ Payment Method</label>
                    <select id="paymentMethod" required>
                        <option value="">-- Select Method --</option>
                        <option value="GCash">GCash</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Cash">Cash</option>
                        <option value="PayMaya">PayMaya</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>üî¢ Reference Number (Optional)</label>
                    <input type="text" id="paymentReference" placeholder="e.g., TRX123456">
                </div>
                
                <div class="form-group">
                    <label>üìù Notes (Optional)</label>
                    <textarea id="paymentNotes" placeholder="Additional notes..." rows="3"></textarea>
                </div>
                
                <button type="submit" class="btn btn-success">‚úÖ Confirm Payment</button>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="close-btn" onclick="closeSettingsModal()">‚úï</button>
            </div>
            
            <div class="settings-grid">
                <div class="setting-card">
                    <div class="setting-title">üé® Community Themes</div>
                    <select id="themeSelect" style="width: 100%; padding: 12px; border-radius: 15px; border: 3px solid var(--border-color); background: var(--light); color: var(--text-color); font-weight: 700;">
                        <option value="theme-purple">üíú Purple (Default)</option>
                        <option value="theme-blue">üíô Blue</option>
                        <option value="theme-green">üíö Green</option>
                        <option value="theme-pink">üíó Pink</option>
                        <option value="theme-orange">üß° Orange</option>
                        <option value="theme-cherry">üå∏ Cherry Blossom</option>
                        <option value="theme-citrus">üçä Citrus Burst</option>
                        <option value="theme-lavender">üíê Lavender Dreams</option>
                        <option value="theme-ocean">üåä Deep Ocean</option>
                        <option value="theme-fire">üî• Fire & Ice</option>
                        <option value="theme-rainbow">üåà Rainbow Pride</option>
                        <option value="theme-dark">üåë Dark Mode Pro</option>
                        <option value="theme-sunshine">‚òÄÔ∏è Sunshine Yellow</option>
                        <option value="theme-mint">üåø Mint Fresh</option>
                        <option value="theme-grape">üçá Grape Soda</option>
                    </select>
                </div>
                
                <div class="setting-card">
                    <div class="setting-title">üåô Dark Mode</div>
                    <button class="btn btn-secondary" id="toggleDarkMode" style="margin-top: 10px;">Toggle Dark Mode</button>
                </div>
                
            
            <!-- Advanced Theme Builder -->
            <div style="margin-top: 30px; padding: 20px; background: var(--light); border-radius: 20px; border: 3px dashed var(--border-color);">
                <h3 style="color: var(--primary); margin-bottom: 15px; font-weight: 800;">üé® Custom Theme Builder</h3>
                <p style="margin-bottom: 15px; opacity: 0.8; font-size: 0.9em;">Create your own custom theme!</p>
                
                <button class="btn btn-info" onclick="toggleThemeBuilder()">üé® Open Theme Builder</button>
            </div>
            
            <div style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="saveSettings()">üíæ Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Theme Builder Modal -->
    <div class="modal" id="themeBuilderModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üé® Custom Theme Builder</h2>
                <button class="close-btn" onclick="closeThemeBuilder()">‚úï</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h3 style="color: var(--primary); margin-bottom: 15px;">Colors</h3>
                    
                    <div class="form-group">
                        <label>üé® Primary Color</label>
                        <input type="color" id="customPrimary" value="#8B5CF6" style="width: 100%; height: 50px; border-radius: 10px;">
                    </div>
                    
                    <div class="form-group">
                        <label>üíó Secondary Color</label>
                        <input type="color" id="customSecondary" value="#EC4899" style="width: 100%; height: 50px; border-radius: 10px;">
                    </div>
                    
                    <div class="form-group">
                        <label>‚úÖ Success Color</label>
                        <input type="color" id="customSuccess" value="#10B981" style="width: 100%; height: 50px; border-radius: 10px;">
                    </div>
                    
                    <div class="form-group">
                        <label>‚ùå Danger Color</label>
                        <input type="color" id="customDanger" value="#EF4444" style="width: 100%; height: 50px; border-radius: 10px;">
                    </div>
                    
                    <div class="form-group">
                        <label>‚ö†Ô∏è Warning Color</label>
                        <input type="color" id="customWarning" value="#F59E0B" style="width: 100%; height: 50px; border-radius: 10px;">
                    </div>
                    
                    <div class="form-group">
                        <label>‚ÑπÔ∏è Info Color</label>
                        <input type="color" id="customInfo" value="#3B82F6" style="width: 100%; height: 50px; border-radius: 10px;">
                    </div>
                </div>
                
                <div>
                    <h3 style="color: var(--primary); margin-bottom: 15px;">Typography & Style</h3>
                    
                    <div class="form-group">
                        <label>üìù Font Family</label>
                        <select id="customFont" style="width: 100%; padding: 12px; border-radius: 10px;">
                            <option value="'Poppins', sans-serif">Poppins</option>
                            <option value="'Roboto', sans-serif">Roboto</option>
                            <option value="'Montserrat', sans-serif">Montserrat</option>
                            <option value="'Inter', sans-serif">Inter</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>üìê Border Radius</label>
                        <select id="customRadius" style="width: 100%; padding: 12px; border-radius: 10px;">
                            <option value="30px">More Rounded</option>
                            <option value="20px">Rounded</option>
                            <option value="10px">Less Rounded</option>
                            <option value="5px">Square</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>‚ö° Animation Speed</label>
                        <select id="customAnimation" style="width: 100%; padding: 12px; border-radius: 10px;">
                            <option value="0.2s">Fast</option>
                            <option value="0.3s">Normal</option>
                            <option value="0.5s">Slow</option>
                            <option value="0s">None</option>
                        </select>
                    </div>
                    
                    <h3 style="color: var(--primary); margin: 20px 0 15px;">Preview</h3>
                    <div id="themePreview" style="padding: 20px; background: var(--light); border-radius: 15px; border: 3px solid var(--border-color);">
                        <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">Primary Button</button>
                        <button class="btn btn-success" style="width: 100%; margin-bottom: 10px;">Success Button</button>
                        <button class="btn btn-danger" style="width: 100%;">Danger Button</button>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="applyCustomTheme()">‚úÖ Apply Theme</button>
                <button class="btn btn-primary" onclick="saveCustomTheme()">üíæ Save Theme</button>
                <button class="btn btn-info" onclick="exportTheme()">üì§ Export</button>
                <button class="btn btn-secondary" onclick="importTheme()">üì• Import</button>
                <button class="btn btn-danger" onclick="resetTheme()">üîÑ Reset</button>
            </div>
        </div>
    </div>

    <!-- Payout Modal -->
    <div class="modal" id="payoutModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üí∞ Admin Payouts</h2>
                <button class="close-btn" onclick="closePayoutModal()">‚úï</button>
            </div>
            
            <div class="period-tabs" style="margin-bottom: 20px;">
                <button class="period-tab active" id="payoutPeriodAll" onclick="setPayoutPeriod('all')">üìä All Time</button>
                <button class="period-tab" id="payoutPeriodWeek" onclick="setPayoutPeriod('week')">üìÖ This Week</button>
                <button class="period-tab" id="payoutPeriodMonth" onclick="setPayoutPeriod('month')">üìÜ This Month</button>
            </div>
            
            <div id="payoutList" class="payout-list">
                <!-- Payout items will be dynamically generated -->
            </div>
        </div>
    </div>

    <!-- Mark Paid Modal -->
    <div class="modal" id="markPaidModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>‚úÖ Mark as Paid</h2>
                <button class="close-btn" onclick="closeMarkPaidModal()">‚úï</button>
            </div>
            
            <form id="markPaidForm" onsubmit="confirmMarkAsPaid(event)">
                <input type="hidden" id="payoutToMarkId">
                <input type="hidden" id="payoutToMarkUserId">
                <input type="hidden" id="payoutToMarkAmount">
                
                <div class="form-group">
                    <label>üí≥ Payment Method</label>
                    <select id="paymentMethod" required>
                        <option value="">-- Select Method --</option>
                        <option value="GCash">GCash</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Cash">Cash</option>
                        <option value="PayMaya">PayMaya</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>üî¢ Reference Number</label>
                    <input type="text" id="paymentReference" placeholder="Transaction/Reference ID">
                </div>
                
                <div class="form-group">
                    <label>üìù Notes (Optional)</label>
                    <textarea id="paymentNotes" rows="3" placeholder="Additional notes..."></textarea>
                </div>
                
                <button type="submit" class="btn btn-success">‚úÖ Confirm Payment</button>
            </form>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal" id="editProductModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>‚úèÔ∏è Edit Product</h2>
                <button class="close-btn" onclick="closeEditProductModal()">‚úï</button>
            </div>
            
            <form id="editProductForm" onsubmit="saveProductEdit(event)">
                <input type="hidden" id="editProductId">
                
                <div class="form-group">
                    <label>üì¶ Product Name</label>
                    <input type="text" id="editProductName" required>
                </div>
                
                <div class="form-group">
                    <label>üõí Buy Price</label>
                    <input type="number" id="editProductBuyPrice" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label>üí∞ Sell Price</label>
                    <input type="number" id="editProductSellPrice" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label>üìÇ Category</label>
                    <select id="editProductCategory" required>
                        <option value="">-- Select Category --</option>
                        <option value="Netflix">Netflix</option>
                        <option value="Disney">Disney</option>
                        <option value="HBO">HBO</option>
                        <option value="YouTube">YouTube</option>
                        <option value="Spotify">Spotify</option>
                        <option value="Canva">Canva</option>
                        <option value="ChatGPT">ChatGPT</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>üìã Account Types</label>
                    <div class="warranty-options">
                        <div class="warranty-option">
                            <input type="checkbox" id="editTypeSolo" value="Solo">
                            <label for="editTypeSolo" class="warranty-label">
                                <span class="warranty-icon">üë§</span> Solo
                            </label>
                        </div>
                        <div class="warranty-option">
                            <input type="checkbox" id="editTypeShared" value="Shared">
                            <label for="editTypeShared" class="warranty-label">
                                <span class="warranty-icon">üë•</span> Shared
                            </label>
                        </div>
                        <div class="warranty-option">
                            <input type="checkbox" id="editTypePremium" value="Premium">
                            <label for="editTypePremium" class="warranty-label">
                                <span class="warranty-icon">‚≠ê</span> Premium
                            </label>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-success">‚úÖ Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span class="toast-icon" id="toastIcon">‚úì</span>
        <span id="toastMessage">Success!</span>
    </div>

<script>
    // =================== APP CONFIGURATION ===================
    const APP_NAME = 'south08';
    
const firebaseConfig = {
  apiKey: "AIzaSyCa4XYpwePgiTWL30sSkIubYbWizTHwEQU",
  authDomain: "maisonetoile-5eee1.firebaseapp.com",
  databaseURL: "https://maisonetoile-5eee1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "maisonetoile-5eee1",
  storageBucket: "maisonetoile-5eee1.firebasestorage.app",
  messagingSenderId: "902250837280",
  appId: "1:902250837280:web:cf56ca8ffc57818cfdd345",
  measurementId: "G-7BD4QNPQK7"
};



    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    function getRef(path) {
        return database.ref(APP_NAME + '/' + path);
    }

console.log('‚úÖ Firebase initialized for app:', APP_NAME);
console.log('üìÇ All data will be stored in:', APP_NAME + '/');

// =================== REAL-TIME CONNECTION MONITORING ===================
let isConnected = false;
let syncStatusElement = null;
let syncStatusTextElement = null;

function updateSyncStatus(status, text) {
    if (!syncStatusElement) {
        syncStatusElement = document.getElementById('syncStatus');
        syncStatusTextElement = document.getElementById('syncStatusText');
    }
    
    if (syncStatusElement && syncStatusTextElement) {
        syncStatusElement.className = 'sync-status ' + status;
        syncStatusTextElement.textContent = text;
    }
}

// Monitor Firebase connection state
const connectedRef = database.ref('.info/connected');
connectedRef.on('value', (snapshot) => {
    isConnected = snapshot.val() === true;
    
    if (isConnected) {
        console.log('üîÑ Real-time sync: CONNECTED');
        updateSyncStatus('connected', 'üîÑ Synced');
    } else {
        console.log('‚ùå Real-time sync: DISCONNECTED');
        updateSyncStatus('disconnected', '‚ùå Offline');
    }
});

// Show syncing indicator when data is being updated
function showSyncingIndicator() {
    updateSyncStatus('syncing', '‚è≥ Syncing...');
    setTimeout(() => {
        if (isConnected) {
            updateSyncStatus('connected', 'üîÑ Synced');
        }
    }, 500);
}

        // =================== DATA MANAGEMENT ===================
        let currentSession = null;
        let currentUsername = '';
        let sales = [];
        let users = [];
        let payouts = [];
let products = [];
let subscriptionProducts = [];
let accounts = []; // Store streaming service accounts
let selectedProfile = null;
let realAdmins = []; // Store real admins from Firebase
let commissionBrackets = []; // Store commission bracket configuration
    let settings = {
            theme: 'theme-purple',
            darkMode: false,
        };

        let calcValue = '0';
        
        // Streaming service categories for profile tracking
        const STREAMING_CATEGORIES = ['Netflix', 'Disney', 'HBO', 'YouTube', 'Prime Video', 'Apple TV+', 'Paramount+', 'Discovery+', 'Crunchyroll', 'VIU', 'WeTV', 'Vimeo', 'iQIYI', 'Loklok', 'iWant', 'Vivaone', 'Vivamax', 'Vivabundle'];

// =================== DEFAULT PRODUCTS CATALOG ===================
const DEFAULT_PRODUCTS = [
    // Disney
    { name: 'Disney Shared', buyPrice: 50, sellPrice: 80, category: 'Disney' },
    { name: 'Disney Solo 1dev', buyPrice: 120, sellPrice: 180, category: 'Disney' },
    { name: 'Disney Solo 2devs', buyPrice: 150, sellPrice: 220, category: 'Disney' },
    
    // HBO
    { name: 'HBO Shared', buyPrice: 45, sellPrice: 75, category: 'HBO' },
    { name: 'HBO Solo 1dev', buyPrice: 110, sellPrice: 170, category: 'HBO' },
    { name: 'HBO Solo 2devs', buyPrice: 140, sellPrice: 210, category: 'HBO' },
    
    // YouTube
    { name: 'YouTube Solo', buyPrice: 100, sellPrice: 150, category: 'YouTube' },
    { name: 'YouTube Famhead', buyPrice: 180, sellPrice: 250, category: 'YouTube' },
    { name: 'YouTube Invite', buyPrice: 50, sellPrice: 90, category: 'YouTube' },
    
    // Spotify
    { name: 'Spotify Standard', buyPrice: 60, sellPrice: 100, category: 'Spotify' },
    
    // Vivaone
    { name: 'Vivaone Solo', buyPrice: 80, sellPrice: 120, category: 'Vivaone' },
    { name: 'Vivaone Shared', buyPrice: 40, sellPrice: 70, category: 'Vivaone' },
    
    // Vivamax
    { name: 'Vivamax Solo', buyPrice: 90, sellPrice: 130, category: 'Vivamax' },
    { name: 'Vivamax Shared', buyPrice: 45, sellPrice: 75, category: 'Vivamax' },
    
    // Vivabundle
    { name: 'Vivabundle Shared', buyPrice: 60, sellPrice: 95, category: 'Vivabundle' },
    { name: 'Vivabundle Solo', buyPrice: 120, sellPrice: 170, category: 'Vivabundle' },
    
    // ChatGPT
    { name: 'ChatGPT Shared', buyPrice: 100, sellPrice: 150, category: 'ChatGPT' },
    { name: 'ChatGPT Solo', buyPrice: 200, sellPrice: 280, category: 'ChatGPT' },
    
    // Remini
    { name: 'Remini 7d Shared', buyPrice: 30, sellPrice: 50, category: 'Remini' },
    { name: 'Remini 7d Solo', buyPrice: 50, sellPrice: 80, category: 'Remini' },
    { name: 'Remini 1m Shared', buyPrice: 80, sellPrice: 120, category: 'Remini' },
    { name: 'Remini 1m Solo', buyPrice: 120, sellPrice: 180, category: 'Remini' },
    
    // CapCut
    { name: 'CapCut 7d Shared', buyPrice: 35, sellPrice: 55, category: 'CapCut' },
    { name: 'CapCut 7d Solo', buyPrice: 55, sellPrice: 85, category: 'CapCut' },
    { name: 'CapCut 1m Shared', buyPrice: 85, sellPrice: 125, category: 'CapCut' },
    { name: 'CapCut 1m Solo', buyPrice: 125, sellPrice: 185, category: 'CapCut' },
    
    // Loklok
    { name: 'Loklok Standard Shared', buyPrice: 40, sellPrice: 65, category: 'Loklok' },
    { name: 'Loklok Basic Shared', buyPrice: 30, sellPrice: 50, category: 'Loklok' },
    
    // iWant
    { name: 'iWant Shared', buyPrice: 35, sellPrice: 60, category: 'iWant' },
    { name: 'iWant Solo', buyPrice: 70, sellPrice: 110, category: 'iWant' },
    
    // Grammarly
    { name: 'Grammarly Shared', buyPrice: 80, sellPrice: 120, category: 'Grammarly' },
    { name: 'Grammarly Solo', buyPrice: 150, sellPrice: 220, category: 'Grammarly' },
    
    // Quillbot
    { name: 'Quillbot Shared', buyPrice: 70, sellPrice: 110, category: 'Quillbot' },
    { name: 'Quillbot Solo', buyPrice: 130, sellPrice: 190, category: 'Quillbot' },
    
    // Prime Video
    { name: 'Prime Video Shared', buyPrice: 55, sellPrice: 90, category: 'Prime Video' },
    { name: 'Prime Video Solo', buyPrice: 110, sellPrice: 160, category: 'Prime Video' },
    
    // iQIYI
    { name: 'iQIYI Shared', buyPrice: 50, sellPrice: 85, category: 'iQIYI' },
    
    // Canva
    { name: 'Canva Solo', buyPrice: 90, sellPrice: 140, category: 'Canva' },
    { name: 'Canva Head', buyPrice: 150, sellPrice: 220, category: 'Canva' },
    { name: 'Canva Invite', buyPrice: 50, sellPrice: 85, category: 'Canva' },
    
    // Netflix
    { name: 'Netflix Mobile', buyPrice: 70, sellPrice: 110, category: 'Netflix' },
    { name: 'Netflix Basic', buyPrice: 100, sellPrice: 150, category: 'Netflix' },
    { name: 'Netflix Standard', buyPrice: 150, sellPrice: 220, category: 'Netflix' },
    { name: 'Netflix Premium', buyPrice: 200, sellPrice: 280, category: 'Netflix' },
    { name: 'Netflix Shared', buyPrice: 60, sellPrice: 100, category: 'Netflix' },
    
    // Apple Music
    { name: 'Apple Music Individual', buyPrice: 100, sellPrice: 150, category: 'Apple Music' },
    { name: 'Apple Music Family', buyPrice: 150, sellPrice: 220, category: 'Apple Music' },
    { name: 'Apple Music Student', buyPrice: 50, sellPrice: 85, category: 'Apple Music' },
    
    // Apple TV+
    { name: 'Apple TV+ Shared', buyPrice: 45, sellPrice: 75, category: 'Apple TV+' },
    { name: 'Apple TV+ Solo', buyPrice: 90, sellPrice: 135, category: 'Apple TV+' },
    
    // Paramount+
    { name: 'Paramount+ Shared', buyPrice: 40, sellPrice: 70, category: 'Paramount+' },
    { name: 'Paramount+ Solo', buyPrice: 85, sellPrice: 130, category: 'Paramount+' },
    
    // Discovery+
    { name: 'Discovery+ Shared', buyPrice: 38, sellPrice: 65, category: 'Discovery+' },
    { name: 'Discovery+ Solo', buyPrice: 80, sellPrice: 125, category: 'Discovery+' },
    
    // Crunchyroll
    { name: 'Crunchyroll Mega Fan', buyPrice: 90, sellPrice: 140, category: 'Crunchyroll' },
    { name: 'Crunchyroll Fan', buyPrice: 60, sellPrice: 100, category: 'Crunchyroll' },
    { name: 'Crunchyroll Shared', buyPrice: 45, sellPrice: 75, category: 'Crunchyroll' },
    
    // VIU
    { name: 'VIU Premium', buyPrice: 55, sellPrice: 90, category: 'VIU' },
    { name: 'VIU Shared', buyPrice: 35, sellPrice: 60, category: 'VIU' },
    
    // WeTV
    { name: 'WeTV VIP Shared', buyPrice: 40, sellPrice: 70, category: 'WeTV' },
    { name: 'WeTV VIP Solo', buyPrice: 80, sellPrice: 120, category: 'WeTV' },
    
    // Vimeo
    { name: 'Vimeo Plus', buyPrice: 60, sellPrice: 100, category: 'Vimeo' },
    { name: 'Vimeo Pro', buyPrice: 150, sellPrice: 220, category: 'Vimeo' },
    { name: 'Vimeo Shared', buyPrice: 40, sellPrice: 70, category: 'Vimeo' },
    
    // LinkedIn Premium
    { name: 'LinkedIn Premium Career', buyPrice: 200, sellPrice: 280, category: 'LinkedIn Premium' },
    { name: 'LinkedIn Premium Business', buyPrice: 250, sellPrice: 350, category: 'LinkedIn Premium' },
    { name: 'LinkedIn Premium Shared', buyPrice: 120, sellPrice: 180, category: 'LinkedIn Premium' },
    
    // Duolingo
    { name: 'Duolingo Plus Shared', buyPrice: 50, sellPrice: 85, category: 'Duolingo' },
    { name: 'Duolingo Plus Solo', buyPrice: 100, sellPrice: 150, category: 'Duolingo' },
    
    // Calm
    { name: 'Calm Shared', buyPrice: 60, sellPrice: 100, category: 'Calm' },
    { name: 'Calm Solo', buyPrice: 120, sellPrice: 180, category: 'Calm' },
    
    // Headspace
    { name: 'Headspace Shared', buyPrice: 55, sellPrice: 95, category: 'Headspace' },
    { name: 'Headspace Solo', buyPrice: 110, sellPrice: 165, category: 'Headspace' },
    
    // Adobe Creative Cloud
    { name: 'Adobe All Apps', buyPrice: 450, sellPrice: 600, category: 'Adobe Creative Cloud' },
    { name: 'Adobe Photography', buyPrice: 200, sellPrice: 280, category: 'Adobe Creative Cloud' },
    { name: 'Adobe Single App', buyPrice: 180, sellPrice: 250, category: 'Adobe Creative Cloud' },
    
    // Microsoft 365
    { name: 'Microsoft 365 Personal', buyPrice: 300, sellPrice: 400, category: 'Microsoft 365' },
    { name: 'Microsoft 365 Family', buyPrice: 400, sellPrice: 550, category: 'Microsoft 365' },
    
    // Notion
    { name: 'Notion Plus', buyPrice: 80, sellPrice: 130, category: 'Notion' },
    { name: 'Notion Business', buyPrice: 150, sellPrice: 220, category: 'Notion' },
    { name: 'Notion Shared', buyPrice: 50, sellPrice: 85, category: 'Notion' },
    
    // Evernote
    { name: 'Evernote Premium', buyPrice: 100, sellPrice: 150, category: 'Evernote' },
    { name: 'Evernote Shared', buyPrice: 60, sellPrice: 100, category: 'Evernote' },
    
    // Dropbox
    { name: 'Dropbox Plus', buyPrice: 120, sellPrice: 180, category: 'Dropbox' },
    { name: 'Dropbox Professional', buyPrice: 200, sellPrice: 280, category: 'Dropbox' },
    { name: 'Dropbox Shared', buyPrice: 70, sellPrice: 110, category: 'Dropbox' }
];

// Function to seed default products on first initialization
function seedDefaultProducts() {
    console.log('üå± Checking if products need to be seeded...');
    
    getRef('products').once('value').then((snapshot) => {
        const existingProducts = snapshot.val();
        
        // Only seed if no products exist
        if (!existingProducts || Object.keys(existingProducts).length === 0) {
            console.log('üå± Seeding default products...');
            
            const productsRef = getRef('products');
            let seedCount = 0;
            
            DEFAULT_PRODUCTS.forEach((product, index) => {
                const productId = Date.now() + index;
                const margin = ((product.sellPrice - product.buyPrice) / product.buyPrice * 100);
                
                const newProduct = {
                    id: productId,
                    name: product.name,
                    buyPrice: product.buyPrice,
                    sellPrice: product.sellPrice,
                    margin: margin,
                    category: product.category || 'General',
                    createdAt: new Date().toISOString()
                };
                
                productsRef.child(productId.toString()).set(newProduct);
                seedCount++;
            });
            
            console.log(`‚úÖ Seeded ${seedCount} default products!`);
            showToast(`üå± Initialized ${seedCount} products!`, 'success');
        } else {
            console.log('‚úÖ Products already exist, skipping seed');
        }
    }).catch((error) => {
        console.error('‚ùå Error seeding products:', error);
    });
}

// =================== SUBSCRIPTION PRODUCTS ===================

function switchProductType(type) {
    document.getElementById('regularProductBtn').classList.remove('active');
    document.getElementById('subscriptionProductBtn').classList.remove('active');
    
    if (type === 'regular') {
        document.getElementById('regularProductBtn').classList.add('active');
        document.getElementById('subscriptionFields').classList.remove('show');
    } else {
        document.getElementById('subscriptionProductBtn').classList.add('active');
        document.getElementById('subscriptionFields').classList.add('show');
    }
}

function handleSubProductNameSelect() {
    const select = document.getElementById('subProductNameSelect');
    const customInput = document.getElementById('subProductName');
    
    if (select.value === 'custom') {
        customInput.style.display = 'block';
        customInput.required = true;
    } else {
        customInput.style.display = 'none';
        customInput.required = false;
    }
}

function renderSubscriptionProducts() {
    const container = document.getElementById('subscriptionProductList');
    if (!container) return;
    
    if (subscriptionProducts.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üé¨</div><p>No subscription products yet</p></div>';
        return;
    }
    
    container.innerHTML = subscriptionProducts.map(product => {
        const availableCount = product.profiles.filter(p => !p.sold).length;
        
        return `
            <div class="subscription-product-item">
                <div class="subscription-header">
                    <div class="subscription-title">üé¨ ${product.name}</div>
                    <div>
                        <button class="action-btn delete-btn" onclick="deleteSubscriptionProduct(${product.id})">üóëÔ∏è</button>
                    </div>
                </div>
                
                <div class="subscription-pricing">
                    <div class="price-tag">üí∞ Full: ‚Ç±${product.fullPrice.toFixed(2)}</div>
                    <div class="price-tag">üë§ Profile: ‚Ç±${product.profilePrice.toFixed(2)}</div>
                    <div class="price-tag">üõí Cost: ‚Ç±${product.buyPrice.toFixed(2)}</div>
                </div>
                
                <div class="availability-status">
                    ${availableCount}/${product.totalProfiles} profiles available
                </div>
                
                <div class="profile-grid">
                    ${product.profiles.map(profile => `
                        <div class="profile-slot ${profile.sold ? 'sold' : 'available'}">
                            <div class="profile-slot-icon">${profile.sold ? '‚úÖ' : 'üì¶'}</div>
                            <div class="profile-slot-label">Profile ${profile.number}</div>
                            <div class="profile-slot-info">${profile.sold ? profile.soldBy : 'Available'}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }).join('');
}

function deleteSubscriptionProduct(productId) {
    if (!confirm('Delete this subscription product?')) return;
    getRef('subscriptionProducts/' + productId).remove()
        .then(() => showToast('üóëÔ∏è Product deleted', 'info'))
        .catch((error) => showToast('‚ùå Error: ' + error.message, 'error'));
}

function handleProductSelectionForSale() {
    const productSelect = document.getElementById('productSelect');
    const productId = parseInt(productSelect.value);
    const saleTypeSelection = document.getElementById('saleTypeSelection');
    if (!saleTypeSelection) return;
    
    const subProduct = subscriptionProducts.find(p => p.id === productId);
    if (subProduct) {
        saleTypeSelection.classList.add('show');
        updateProfileSelection(subProduct);
    } else {
        saleTypeSelection.classList.remove('show');
    }
}

function updateProfileSelection(subProduct) {
    const profileGrid = document.getElementById('profileSelectGrid');
    if (!profileGrid) return;
    
    const availableProfiles = subProduct.profiles.filter(p => !p.sold);
    profileGrid.innerHTML = availableProfiles.map(profile => `
        <div class="profile-select-btn" onclick="selectProfile(${profile.number})" id="profileBtn${profile.number}">
            Profile ${profile.number}
        </div>
    `).join('');
}

function selectProfile(number) {
    selectedProfile = number;
    document.querySelectorAll('.profile-select-btn').forEach(btn => btn.classList.remove('selected'));
    const btn = document.getElementById('profileBtn' + number);
    if (btn) btn.classList.add('selected');
}

// =================== END SUBSCRIPTION PRODUCTS ===================
        // =================== INITIALIZATION ===================
        function init() {
            console.log('üöÄ Initializing...');
            checkAuth();
            seedDefaultProducts(); // Seed default products if needed
            loadAllData();
            applySettings();
            // ‚úÖ FIXED: Setup event listeners AFTER DOM is ready
            setTimeout(setupEventListeners, 100);
        }

        function checkAuth() {
            const session = localStorage.getItem('session');
            if (!session) {
                window.location.href = 'index.html';
                return;
            }
            
            currentSession = JSON.parse(session);
            currentUsername = currentSession.username;
            console.log('‚úÖ Logged in as:', currentSession.customName);
            
            
            document.getElementById('userName').textContent = currentSession.customName;
            document.getElementById('userRole').textContent = currentSession.role === 'owner' ? 'üëë OWNER' : 'üë§ ADMIN';
            document.getElementById('userAvatar').textContent = currentSession.customName.charAt(0).toUpperCase();
            
            if (currentSession.role === 'owner') {
                document.getElementById('btnUsers').style.display = 'inline-block';
                document.getElementById('btnProducts').style.display = 'inline-block';
                document.getElementById('btnPayout').style.display = 'inline-block';
                document.getElementById('inventoryDashboardSection').style.display = 'block';
                // Load commission brackets for owner
                loadCommissionBrackets();
            } else {
                // Admins can also view/edit products
                document.getElementById('btnProducts').style.display = 'inline-block';
                document.getElementById('userFilter').style.display = 'none';
                document.getElementById('adminColumn').style.display = 'none';
                document.getElementById('dashboardSubtitle').textContent = currentSession.customName + "'s Dashboard";
                // Load commission brackets for admins to use in calculations
                loadCommissionBrackets();
            }
        }

// =================== LOAD REAL ADMINS ===================
function loadRealAdmins() {
    realAdmins = [];
    users.forEach(user => {
        if (user.role === 'admin') {
            realAdmins.push({
                username: user.customName || user.username,
                commission: user.profitPercent || 25,
                uid: user.id
            });
        }
    });
    console.log('‚úÖ Loaded real admins for calculations:', realAdmins.length);
    
    // Refresh product calculation if it's visible
    if (document.getElementById('productCalculation').style.display === 'block') {
        autoCalculatePrices();
    }
}

function loadAllData() {
    console.log('üîÑ Loading all data from:', APP_NAME + '/');
    
    // Load users
    getRef('users').on('value', (snapshot) => {
        const usersData = snapshot.val() || {};
        users = Object.values(usersData);
        console.log('‚úÖ Loaded users:', users.length);
        
        // Load real admins for product calculations
        loadRealAdmins();
        
        // Update user filter for owner
        if (currentSession.role === 'owner') {
            const userFilter = document.getElementById('userFilter');
            userFilter.innerHTML = '<option value="all">All Admins</option>';
            users.forEach(user => {
                if (user.role === 'admin') {
                    userFilter.innerHTML += `<option value="${user.id}">${user.customName}</option>`;
                }
            });
            
            // Render user list in Users Management modal
            renderUserList();
        }
        
        // Load sales AFTER users are loaded (so we can match user info)
        loadAllSalesData();
    });
    
    // Load products
    getRef('products').on('value', (snapshot) => {
        const productsData = snapshot.val() || {};
        products = Object.values(productsData);
        console.log('‚úÖ Loaded products:', products.length);
        updateProductDropdown();
        // Both owners and admins can view products
        if (currentSession.role === 'owner' || currentSession.role === 'admin') {
            renderProductList();
        }
    });

    // Load subscription products
    getRef('subscriptionProducts').on('value', (snapshot) => {
        const subProductsData = snapshot.val() || {};
        subscriptionProducts = Object.values(subProductsData);
        console.log('üì∫ Loaded subscription products:', subscriptionProducts.length);
        renderSubscriptionProducts();
        updateProductDropdown();
    });
    
    // Load payouts
    getRef('payouts').on('value', (snapshot) => {
        const payData = snapshot.val() || {};
        payouts = Object.values(payData);
        renderPayoutList();
        autoCalculatePayouts();
    });

    // Load accounts (for profile tracking)
    getRef('accounts').on('value', (snapshot) => {
        const accountsData = snapshot.val() || {};
        accounts = Object.values(accountsData);
        console.log('üé¨ Loaded accounts:', accounts.length);
        populateAccountDropdown();
        if (currentSession.role === 'owner') {
            renderInventoryDashboard();
        }
    });

    // Load settings with real-time sync
    getRef('settings/' + currentUsername).on('value', (snapshot) => {
        if (snapshot.exists()) {
            const newSettings = snapshot.val();
            // Only update and apply if settings actually changed
            if (JSON.stringify(settings) !== JSON.stringify(newSettings)) {
                console.log('‚öôÔ∏è Settings updated in real-time');
                settings = newSettings;
                applySettings();
            }
        } else {
            // Use default settings if none exist
            applySettings();
        }
    });
    
    // Populate Sold By dropdown with real admin names
    populateSoldByDropdown();
}

function loadAllSalesData() {
    console.log('üîÑ Loading sales data...');
    
    if (currentSession.role === 'owner') {
        // Owner: Load sales from ALL users
        getRef('sales').on('value', (snapshot) => {
            const salesData = snapshot.val() || {};
            sales = [];
            
            console.log('üìä Raw sales data structure:', Object.keys(salesData));
            
            Object.keys(salesData).forEach(userKey => {
                const userSales = salesData[userKey];
                console.log(`üë§ User ${userKey} has sales:`, userSales);
                
                if (userSales && typeof userSales === 'object') {
                    Object.keys(userSales).forEach(saleKey => {
                        const sale = userSales[saleKey];
                        
                        // Ensure sale has all required properties
                        sale.id = saleKey;
                        sale.userKey = userKey; // Store the Firebase user key
                        
                        // Find the user who owns this sale
                        const saleUser = users.find(u => {
                            const safeUsername = u.username.replace(/[.#$/[\]]/g, '_');
                            return safeUsername === userKey;
                        });
                        
                        if (saleUser) {
                            sale.userName = saleUser.customName || saleUser.username;
                            sale.userId = saleUser.id;
                            sale.userRole = saleUser.role;
                        } else {
                            // Fallback: use the userKey as username
                            sale.userName = userKey;
                            sale.userId = userKey;
                            sale.userRole = 'unknown';
                        }
                        
                        sales.push(sale);
                    });
                }
            });
            
            console.log('‚úÖ Owner loaded all sales:', sales.length);
            
            // Debug: Show sales distribution
            const userSalesCount = {};
            sales.forEach(sale => {
                userSalesCount[sale.userName] = (userSalesCount[sale.userName] || 0) + 1;
            });
            console.log('üìä Sales distribution:', userSalesCount);
            
            calculateStats();
            renderSalesTable();
            updateCharts();
        });
    } else {
        // Admin: Load only their own sales
        const userKey = currentSession.username.replace(/[.#$/[\]]/g, '_');
        console.log('üë§ Admin loading sales from path:', 'sales/' + userKey);
        
        getRef('sales/' + userKey).on('value', (snapshot) => {
            const salesData = snapshot.val() || {};
            sales = [];
            
            console.log('üìä Admin sales data:', salesData);
            
            Object.keys(salesData).forEach(saleKey => {
                const sale = salesData[saleKey];
                sale.id = saleKey;
                sale.userName = currentSession.customName;
                sale.userId = currentSession.id;
                sale.userRole = currentSession.role;
                sales.push(sale);
            });
            
            console.log('‚úÖ Admin loaded sales:', sales.length);
            calculateStats();
            renderSalesTable();
            updateCharts();
        });
    }
}

// Populate Sold By dropdown with admin names
function populateSoldByDropdown() {
    const soldBySelect = document.getElementById('soldBySelect');
    if (!soldBySelect) return;
    
    soldBySelect.innerHTML = '<option value="">-- Select Admin --</option>';
    
    // Add current user first
    soldBySelect.innerHTML += `<option value="${currentSession.username}">${currentSession.customName} (You)</option>`;
    
    // Add other admins
    users.forEach(user => {
        if (user.role === 'admin' && user.username !== currentSession.username) {
            soldBySelect.innerHTML += `<option value="${user.username}">${user.customName}</option>`;
        }
    });
}

function saveSettings() {
    settings.theme = document.getElementById('themeSelect').value;
    
    showSyncingIndicator();
    getRef('settings/' + currentUsername).set(settings)
        .then(() => {
            showToast('‚úÖ Settings saved!', 'success');
            closeSettingsModal();
        })
        .catch((error) => {
            showToast('‚ùå Error: ' + error.message, 'error');
        });
}

function applySettings() {
    document.body.className = settings.theme;
    if (settings.darkMode) {
        document.body.classList.add('dark-mode');
    }
    
    document.getElementById('themeSelect').value = settings.theme;
}

        // =================== PRODUCT MANAGEMENT ===================
        
        // Handle Product Name Selection
        function handleProductNameSelect() {
            const select = document.getElementById('productNameSelect');
            const customInput = document.getElementById('newProductName');
            
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                customInput.required = true;
                customInput.focus();
            } else if (select.value === '') {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = select.value;
            }
        }

function autoCalculatePrices() {
    const buy = parseFloat(document.getElementById('newBuyPrice').value) || 0;
    const sell = parseFloat(document.getElementById('newSellPrice').value) || 0;
    
    // Validate prices
    if (buy <= 0 || sell <= 0) {
        document.getElementById('productCalculation').style.display = 'none';
        return;
    }
    
    if (sell <= buy) {
        showToast('Sell price must be greater than buy price!', 'error');
        document.getElementById('productCalculation').style.display = 'none';
        return;
    }
    
    // Calculate total profit
    const totalProfit = sell - buy;
    
    // Calculate margin percentage
    const marginPercent = ((totalProfit / buy) * 100).toFixed(2);
    
    // Update display
    document.getElementById('autoProfit').textContent = `‚Ç±${totalProfit.toFixed(2)}`;
    document.getElementById('autoProfitPercent').textContent = `${marginPercent}%`;
    document.getElementById('newMargin').value = marginPercent;
    
    // Display real admin commissions
    const adminCommissionsList = document.getElementById('adminCommissionsList');
    if (realAdmins.length === 0) {
        adminCommissionsList.innerHTML = `
            <div class="price-info-row">
                <span class="price-info-label">‚ÑπÔ∏è No admins yet</span>
                <span class="price-info-value">Add admins in User Management</span>
            </div>
        `;
    } else {
        adminCommissionsList.innerHTML = realAdmins.map(admin => {
            const adminCommission = totalProfit * (admin.commission / 100);
            const ownerProfit = totalProfit - adminCommission;
            return `
                <div class="price-info-row">
                    <span class="price-info-label">üë§ ${admin.username} (${admin.commission}%)</span>
                    <span class="price-info-value">${admin.username}: ‚Ç±${adminCommission.toFixed(2)} | You: ‚Ç±${ownerProfit.toFixed(2)}</span>
                </div>
            `;
        }).join('');
    }
    
    // Show the calculation card
    document.getElementById('productCalculation').style.display = 'block';
}

        // Add Product
        document.getElementById('addProductForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (currentSession.role !== 'owner') {
                showToast('‚ùå Only owner can add products', 'error');
                return;
            }
            
            const nameSelect = document.getElementById('productNameSelect');
            const customInput = document.getElementById('newProductName');
            let productName = nameSelect.value === 'custom' ? customInput.value.trim() : nameSelect.value;
            
            if (!productName) {
                showToast('‚ö†Ô∏è Please select or enter a product name', 'error');
                return;
            }
            
            const buyPrice = parseFloat(document.getElementById('newBuyPrice').value);
            const sellPrice = parseFloat(document.getElementById('newSellPrice').value);
            
            if (buyPrice >= sellPrice) {
                showToast('‚ö†Ô∏è Sell price must be higher than buy price', 'error');
                return;
            }
            
            const profit = sellPrice - buyPrice;
            const margin = ((profit / buyPrice) * 100);
            
            const newProduct = {
                id: Date.now(),
                name: productName,
                buyPrice: buyPrice,
                sellPrice: sellPrice,
                margin: margin,
                createdDate: new Date().toISOString().split('T')[0]
            };
            
            showSyncingIndicator();
            getRef('products/' + newProduct.id).set(newProduct)
                .then(() => {
                    document.getElementById('addProductForm').reset();
                    document.getElementById('newProductName').style.display = 'none';
                    document.getElementById('productCalculation').style.display = 'none';
                    showToast('‚úÖ Product added successfully!', 'success');
                })
                .catch((error) => {
                    showToast('‚ùå Error: ' + error.message, 'error');
                });
        });

// Add Subscription Product
document.getElementById('addSubscriptionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (currentSession.role !== 'owner') {
        showToast('‚ùå Only owner can add products', 'error');
        return;
    }
    
    const nameSelect = document.getElementById('subProductNameSelect');
    const customName = document.getElementById('subProductName');
    const productName = nameSelect.value === 'custom' ? customName.value : nameSelect.value;
    
    if (!productName) {
        showToast('‚ö†Ô∏è Please enter a product name', 'error');
        return;
    }
    
    const buyPrice = parseFloat(document.getElementById('subBuyPrice').value);
    const fullPrice = parseFloat(document.getElementById('subFullPrice').value);
    const totalProfiles = parseInt(document.getElementById('subTotalProfiles').value);
const soloPrice = parseFloat(document.getElementById('subSoloPrice').value);
const sharedPrice = parseFloat(document.getElementById('subSharedPrice').value);    
    const profiles = [];
    for (let i = 1; i <= totalProfiles; i++) {
        profiles.push({
            number: i,
            sold: false,
            soldBy: '',
            soldDate: ''
        });
    }
    
    const newProduct = {
        id: Date.now(),
        name: productName,
        buyPrice: buyPrice,
        fullPrice: fullPrice,
        totalProfiles: totalProfiles,
soloPrice: soloPrice,
sharedPrice: sharedPrice,
        profiles: profiles,
        createdAt: new Date().toISOString().split('T')[0]
    };
    
    showSyncingIndicator();
    getRef('subscriptionProducts/' + newProduct.id).set(newProduct)
        .then(() => {
            document.getElementById('addSubscriptionForm').reset();
            document.getElementById('subProductName').style.display = 'none';
            showToast('‚úÖ Subscription product added successfully!', 'success');
        })
        .catch((error) => {
            showToast('‚ùå Error: ' + error.message, 'error');
        });
});
// Update Product Dropdown
function updateProductDropdown() {
    const select = document.getElementById('productSelect');
    select.innerHTML = '<option value="">-- Select Product --</option>';
    
    // Group products by category
    const categories = {};
    products.forEach(product => {
        const category = product.category || 'Other';
        if (!categories[category]) {
            categories[category] = [];
        }
        categories[category].push(product);
    });
    
    // Add regular products grouped by category
    Object.keys(categories).sort().forEach(category => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = `üì¶ ${category}`;
        
        categories[category].forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = `${product.name} - ‚Ç±${product.sellPrice.toFixed(2)}`;
            optgroup.appendChild(option);
        });
        
        select.appendChild(optgroup);
    });
    
    // Add subscription products
    if (subscriptionProducts.length > 0) {
        const subOptgroup = document.createElement('optgroup');
        subOptgroup.label = 'üé¨ Subscription Products';
        
        subscriptionProducts.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = product.name;
            subOptgroup.appendChild(option);
        });
        
        select.appendChild(subOptgroup);
    }
}

        // Render Product List
        function renderProductList() {
            const productList = document.getElementById('productList');
            
            if (products.length === 0) {
                productList.innerHTML = '<div class="empty-state"><div class="empty-icon">üì¶</div><p>No products yet</p></div>';
                return;
            }
            
            productList.innerHTML = products.map(product => {
                const profit = product.sellPrice - product.buyPrice;
                
                // Calculate admin commission if user is admin
                let adminCommission = 0;
                let adminEarns = 0;
                let ownerGets = 0;
                
                if (currentSession.role === 'admin') {
                    adminCommission = currentSession.profitPercent || 25;
                    adminEarns = profit * (adminCommission / 100);
                    ownerGets = profit - adminEarns;
                }
                
                // Check for custom commission
                let customCommissionIndicator = '';
                if (product.customCommissions && currentSession.role === 'admin') {
                    const customComm = product.customCommissions[currentSession.id];
                    if (customComm !== undefined) {
                        adminCommission = customComm;
                        adminEarns = profit * (adminCommission / 100);
                        ownerGets = profit - adminEarns;
                        customCommissionIndicator = '‚ú® Custom';
                    }
                }
                
                return `
                    <div class="product-item">
                        <div class="product-item-header">
                            <div class="product-item-name">${product.name}</div>
                            <div>
                                ${currentSession.role === 'owner' ?
                                    `<button class="action-btn edit-btn" onclick="editProduct(${product.id})">‚úèÔ∏è Edit</button>` : ''}
                                ${currentSession.role === 'owner' ?
                                    `<button class="action-btn delete-btn" onclick="deleteProduct(${product.id})">üóëÔ∏è Delete</button>` : ''}
                            </div>
                        </div>
                        <div class="product-item-details">
                            <div class="product-detail">
                                <div class="product-detail-label">üõí Buy Price</div>
                                <div class="product-detail-value">‚Ç±${product.buyPrice.toFixed(2)}</div>
                            </div>
                            <div class="product-detail">
                                <div class="product-detail-label">üí∞ Sell Price</div>
                                <div class="product-detail-value">‚Ç±${product.sellPrice.toFixed(2)}</div>
                            </div>
                            <div class="product-detail">
                                <div class="product-detail-label">üìä Margin</div>
                                <div class="product-detail-value">${product.margin.toFixed(2)}%</div>
                            </div>
                            <div class="product-detail">
                                <div class="product-detail-label">${currentSession.role === 'admin' ? 'üí∞ Total Profit' : 'üéØ Your Profit'}</div>
                                <div class="product-detail-value" style="color: var(--success); font-size: 1.3em;">‚Ç±${profit.toFixed(2)}</div>
                            </div>
                            ${currentSession.role === 'admin' ? `
                                <div class="product-detail">
                                    <div class="product-detail-label">üë§ Your Commission ${customCommissionIndicator}</div>
                                    <div class="product-detail-value">${adminCommission}%</div>
                                </div>
                                <div class="product-detail">
                                    <div class="product-detail-label">üíµ You Earn</div>
                                    <div class="product-detail-value" style="color: var(--primary); font-size: 1.2em;">‚Ç±${adminEarns.toFixed(2)}</div>
                                </div>
                                <div class="product-detail">
                                    <div class="product-detail-label">üëë Owner Gets</div>
                                    <div class="product-detail-value">‚Ç±${ownerGets.toFixed(2)}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // =================== PRODUCT FILTERING & SORTING ===================
        function filterProducts(category = '') {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            
            const filteredProducts = products.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm);
                const matchesCategory = !category || category === 'all' || product.category === category;
                return matchesSearch && matchesCategory;
            });
            
            // Temporarily replace products array for rendering
            const originalProducts = [...products];
            products = filteredProducts;
            renderProductList();
            products = originalProducts;
        }

        function sortProducts(sortBy) {
            const sortedProducts = [...products];
            
            if (sortBy === 'name') {
                sortedProducts.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortBy === 'price') {
                sortedProducts.sort((a, b) => b.sellPrice - a.sellPrice);
            }
            
            // Temporarily replace products array for rendering
            const originalProducts = [...products];
            products = sortedProducts;
            renderProductList();
            products = originalProducts;
        }

        // =================== PRODUCT SELECTION & DISPLAY ===================
        
        // Show product details when selected
        document.getElementById('productSelect').addEventListener('change', function() {
            const productId = parseInt(this.value);
            displayProductDetails(productId);
            handleProductChangeForProfileTracking(productId);
        });

        // Handle product selection for profile tracking
        function handleProductChangeForProfileTracking(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                document.getElementById('profileTrackingFields').style.display = 'none';
                return;
            }
            
            // Check if product is a streaming service
            const isStreaming = STREAMING_CATEGORIES.includes(product.category);
            
            if (isStreaming) {
                document.getElementById('profileTrackingFields').style.display = 'block';
                populateAccountDropdown(product.category);
            } else {
                document.getElementById('profileTrackingFields').style.display = 'none';
            }
        }

        // Populate account dropdown based on product category
        function populateAccountDropdown(category) {
            const accountSelect = document.getElementById('accountIdSelect');
            if (!accountSelect) return;
            
            accountSelect.innerHTML = '<option value="">-- Select Account --</option>';
            
            const filteredAccounts = accounts.filter(acc => {
                const matchesProduct = acc.product && acc.product.includes(category);
                const accountStatus = (acc.status || 'stock');
                return matchesProduct && accountStatus !== 'sold';
            });

            filteredAccounts.forEach(account => {
                const statusLabel = (account.status || 'stock').toUpperCase();
                accountSelect.innerHTML += `<option value="${account.id}">${account.id} - ${account.product} (${statusLabel})</option>`;
            });

            if (filteredAccounts.length === 0) {
                accountSelect.innerHTML += '<option value="" disabled>All accounts for this product are sold. Create a new one.</option>';
            }
        }

        // Update profile status when profile is selected
        function updateProfileStatus() {
            const accountId = document.getElementById('accountIdSelect').value;
            const profileNumber = document.getElementById('profileNumberSelect').value;
            const profileType = document.querySelector('input[name="profileType"]:checked')?.value;
            
            if (!accountId || !profileNumber) {
                document.getElementById('profileStatusDisplay').style.display = 'none';
                return;
            }
            
            // Find sales for this account and profile
            const existingSales = sales.filter(s => 
                s.accountId === accountId && 
                s.profileNumber === parseInt(profileNumber)
            );
            
            const maxSlots = profileType === 'Solo' ? 1 : 2;
            const filledSlots = existingSales.length;
            const availableSlots = maxSlots - filledSlots;
            
            // Determine status
            let statusText = '';
            let statusColor = '';
            
            if (filledSlots === 0) {
                statusText = `‚úÖ AVAILABLE (0/${maxSlots} slots filled)`;
                statusColor = 'var(--success)';
            } else if (filledSlots < maxSlots) {
                statusText = `‚ö†Ô∏è HALF FILLED (${filledSlots}/${maxSlots} slots filled)`;
                statusColor = 'var(--warning)';
            } else {
                statusText = `üî¥ FULL (${filledSlots}/${maxSlots} slots filled)`;
                statusColor = 'var(--danger)';
            }
            
            document.getElementById('profileStatusText').textContent = statusText;
            document.getElementById('profileStatusText').style.color = statusColor;
            
            // Show slot details
            let slotDetails = '<strong>Slot Details:</strong><br>';
            for (let i = 1; i <= maxSlots; i++) {
                const slotSale = existingSales.find(s => s.slotNumber === i);
                if (slotSale) {
                    slotDetails += `‚Ä¢ Slot ${i}: ‚úÖ SOLD by ${slotSale.soldBy} (${slotSale.date})<br>`;
                } else {
                    slotDetails += `‚Ä¢ Slot ${i}: üü¢ AVAILABLE ‚Üê You're selling this<br>`;
                }
            }
            
            document.getElementById('profileSlotDetails').innerHTML = slotDetails;
            document.getElementById('profileStatusDisplay').style.display = 'block';
        }

// Handle product selection for subscription products
document.getElementById('productSelect').addEventListener('change', handleProductSelectionForSale);

// Handle sale type radio buttons
document.querySelectorAll('input[name="saleType"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const profileSelection = document.getElementById('profileSelection');
        if (this.value === 'profile') {
            profileSelection.style.display = 'block';
        } else {
            profileSelection.style.display = 'none';
            selectedProfile = null;
        }
    });
});
        // Update when quantity changes
        document.getElementById('productQuantity').addEventListener('input', function() {
            const productId = parseInt(document.getElementById('productSelect').value);
            if (productId) {
                displayProductDetails(productId);
            }
        });

        function displayProductDetails(productId) {
            if (!productId) {
                document.getElementById('productDetailsCard').style.display = 'none';
                document.getElementById('totalEarningsCard').style.display = 'none';
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const quantity = parseInt(document.getElementById('productQuantity').value) || 1;
            
            // Calculate prices
            const buyPrice = product.buyPrice;
            const sellPrice = product.sellPrice;
            const margin = product.margin;
            
            // Calculate profit first: Profit = Sales - Capital
            const actualProfit = sellPrice - buyPrice;
            
            // Get commission rate based on brackets (for admins) or use 100% for owner
            let userCommissionPercent;
            if (currentSession.role === 'owner') {
                userCommissionPercent = 100; // Owner gets 100% of profit
            } else {
                // For admins, use bracket-based commission or fallback to profitPercent
                userCommissionPercent = getCommissionRateForProfit(actualProfit);
            }
            
            // Calculate commission: Salary = Profit √ó Rate (%)
            const commissionPerUnit = (actualProfit * userCommissionPercent) / 100;
            
            // Display price (what customer pays)
            const userPrice = sellPrice;
            
            // Commission amount (what user earns)
            const yourCommission = currentSession.role === 'owner' ? actualProfit : commissionPerUnit;
            
            // Update single unit display
            document.getElementById('productPrice').textContent = '‚Ç±' + userPrice.toFixed(2);
            document.getElementById('productMargin').textContent = margin.toFixed(2) + '%';
            document.getElementById('productCommission').textContent = '‚Ç±' + yourCommission.toFixed(2) + ' (' + userCommissionPercent.toFixed(1) + '%)';
            document.getElementById('productDetailsCard').style.display = 'block';
            
            // Update total earnings
            const totalPrice = userPrice * quantity;
            const totalEarnings = yourCommission * quantity;
            
            document.getElementById('totalPrice').textContent = '‚Ç±' + totalPrice.toFixed(2);
            document.getElementById('totalEarnings').textContent = '‚Ç±' + totalEarnings.toFixed(2);
            document.getElementById('totalEarningsCard').style.display = 'block';
        }

// DELETE SALE - FIXED FOR OWNER DELETING ADMIN SALES
function deleteSale(saleId, saleUserId = null) {
    console.log('üîç Delete called for sale:', saleId, 'User ID:', saleUserId);
    
    // Determine the correct Firebase path
    let saleRef;
    let userKey;

    if (currentSession.role === 'owner' && saleUserId && saleUserId !== currentSession.id) {
        // Owner deleting admin sale - find admin's username
        const adminUser = users.find(u => u.id === saleUserId);
        if (adminUser) {
            userKey = adminUser.username.replace(/[.#$/[\]]/g, '_');
            saleRef = getRef(`sales/${userKey}/${saleId}`);
            console.log('üëë Owner deleting admin sale, path:', `sales/${userKey}/${saleId}`);
        } else {
            showToast('‚ùå Could not find admin user', 'error');
            return;
        }
    } else {
        // Regular deletion (own sales)
        userKey = currentSession.username.replace(/[.#$/[\]]/g, '_');
        saleRef = getRef(`sales/${userKey}/${saleId}`);
        console.log('üë§ Deleting own sale, path:', `sales/${userKey}/${saleId}`);
    }
    
    // First, check if sale exists and get its data
    saleRef.once('value').then((snapshot) => {
        const sale = snapshot.val();
        if (!sale) {
            showToast('‚ùå Sale not found', 'error');
            return;
        }

        console.log('üì¶ Sale data:', sale);
        
        // Get creator info
        const saleCreatorId = sale.userId;
        const saleCreatorRole = sale.userRole;
        const currentUserId = currentSession.id;
        const currentUserRole = currentSession.role;

        console.log('üë§ Sale creator:', saleCreatorId, saleCreatorRole);
        console.log('üéØ Current user:', currentUserId, currentUserRole);

        // FIXED PERMISSION CHECK - OWNER CAN DELETE ADMIN SALES
        let canDelete = false;

        if (currentUserRole === 'owner') {
            // ‚úÖ OWNER: Can delete ANY sale (admin sales, user sales, own sales)
            canDelete = true;
            console.log('‚úÖ Owner permission granted - can delete any sale');
        } 
        else if (currentUserRole === 'admin') {
            // ‚úÖ ADMIN: Can delete their own sales ONLY
            canDelete = (saleCreatorId === currentUserId);
            console.log('üîß Admin permission:', canDelete);
        } 
        else {
            // ‚úÖ USER: Can delete their own sales ONLY
            canDelete = (saleCreatorId === currentUserId);
            console.log('üë§ User permission:', canDelete);
        }

        if (!canDelete) {
            const errorMsg = `üö´ Permission Denied!\nYour Role: ${currentUserRole}\nSale Creator: ${saleCreatorRole || 'Unknown'}`;
            alert(errorMsg);
            showToast('‚ùå You cannot delete this sale', 'error');
            return;
        }

        // CONFIRM DELETION
        if (!confirm(`üóëÔ∏è Delete this sale?\nProduct: ${sale.productName || sale.product}\nBuyer: ${sale.buyerUsername}`)) {
            return;
        }

        // DELETE FROM FIREBASE
        saleRef.remove()
            .then(() => {
                console.log('‚úÖ Sale deleted from Firebase');
                
                // SUCCESS MESSAGE
                showToast('üóëÔ∏è Sale deleted', 'success');
                autoCalculatePayouts();
                
                // REMOVE FROM UI
                const saleRow = document.querySelector(`[data-sale-id="${saleId}"]`);
                if (saleRow) {
                    saleRow.remove();
                    console.log('‚úÖ Removed from UI');
                } else {
                    console.log('üîÑ Row not found, refreshing table...');
                    renderSalesTable(); // Refresh entire table
                }
                
                // Also remove from local sales array to keep sync
                sales = sales.filter(s => s.id !== saleId);
                calculateStats(); // Update stats
            })
            .catch((error) => {
                console.error('‚ùå Firebase error:', error);
                showToast('‚ùå Error deleting sale: ' + error.message, 'error');
            });
    }).catch((error) => {
        console.error('‚ùå Fetch error:', error);
        showToast('‚ùå Error fetching sale: ' + error.message, 'error');
    });
}
        // Edit Product
        function editProduct(productId) {
            // Prevent admins from editing products
            if (currentSession.role !== 'owner') {
                showToast('‚ùå Only owner can edit product prices and rates', 'error');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // Pre-fill the form
            document.getElementById('editProductId').value = product.id;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductBuyPrice').value = product.buyPrice;
            document.getElementById('editProductSellPrice').value = product.sellPrice;
            document.getElementById('editProductCategory').value = product.category || 'Other';
            
            // Set account type checkboxes
            document.getElementById('editTypeSolo').checked = false;
            document.getElementById('editTypeShared').checked = false;
            document.getElementById('editTypePremium').checked = false;
            
            if (product.accountTypes) {
                if (product.accountTypes.includes('Solo')) {
                    document.getElementById('editTypeSolo').checked = true;
                }
                if (product.accountTypes.includes('Shared')) {
                    document.getElementById('editTypeShared').checked = true;
                }
                if (product.accountTypes.includes('Premium')) {
                    document.getElementById('editTypePremium').checked = true;
                }
            }
            
            // Show the modal
            document.getElementById('editProductModal').classList.add('show');
        }

        function closeEditProductModal() {
            document.getElementById('editProductModal').classList.remove('show');
        }

        function saveProductEdit(event) {
            event.preventDefault();

            const productId = parseInt(document.getElementById('editProductId').value);
            const name = document.getElementById('editProductName').value.trim();
            const buyPrice = parseFloat(document.getElementById('editProductBuyPrice').value);
            const sellPrice = parseFloat(document.getElementById('editProductSellPrice').value);
            const category = document.getElementById('editProductCategory').value;
            
            if (sellPrice <= buyPrice) {
                showToast('‚ö†Ô∏è Sell price must be greater than buy price', 'error');
                return;
            }
            
            // Get selected account types
            const accountTypes = [];
            if (document.getElementById('editTypeSolo').checked) accountTypes.push('Solo');
            if (document.getElementById('editTypeShared').checked) accountTypes.push('Shared');
            if (document.getElementById('editTypePremium').checked) accountTypes.push('Premium');
            
            const margin = ((sellPrice - buyPrice) / buyPrice * 100);
            
            const updatedProduct = {
                id: productId,
                name: name,
                buyPrice: buyPrice,
                sellPrice: sellPrice,
                margin: margin,
                category: category,
                accountTypes: accountTypes,
                updatedDate: new Date().toISOString().split('T')[0]
            };
            
            showSyncingIndicator();
            getRef('products/' + productId).update(updatedProduct)
                .then(() => {
                    closeEditProductModal();
                    showToast('‚úÖ Product updated successfully!', 'success');
                    renderProductList();
                })
                .catch((error) => {
                    showToast('‚ùå Error: ' + error.message, 'error');
                });
        }

        function deleteProduct(productId) {
            if (currentSession.role !== 'owner') {
                showToast('‚ùå Only owner can delete products', 'error');
                return;
            }

            const normalizedId = (typeof productId === 'string' && !isNaN(productId)) ? parseInt(productId, 10) : productId;
            const product = products.find(p => p.id === normalizedId || p.id === productId);
            if (!product) {
                showToast('‚ö†Ô∏è Product not found', 'error');
                return;
            }

            if (!confirm(`üóëÔ∏è Delete product "${product.name}"? This action cannot be undone.`)) {
                return;
            }

            showSyncingIndicator();
            const firebaseId = product.id;
            getRef('products/' + firebaseId).remove()
                .then(() => {
                    showToast('üóëÔ∏è Product deleted successfully!', 'success');
                    products = products.filter(p => p.id !== firebaseId);
                    renderProductList();
                    updateProductDropdown();
                })
                .catch((error) => {
                    showToast('‚ùå Error: ' + error.message, 'error');
                });
        }

        // =================== SALES MANAGEMENT ===================
        
        // Add Sale
        document.getElementById('addSaleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productId = parseInt(document.getElementById('productSelect').value);
            
            if (!productId) {
                showToast('‚ö†Ô∏è Please select a product', 'error');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            const isStreaming = STREAMING_CATEGORIES.includes(product.category);
            
            // Check if profile tracking fields are shown
            if (isStreaming && document.getElementById('profileTrackingFields').style.display !== 'none') {
                // Validate profile tracking fields
                const accountId = document.getElementById('accountIdSelect').value;
                const profileNumber = document.getElementById('profileNumberSelect').value;
                const profileType = document.querySelector('input[name="profileType"]:checked');
                const soldBy = document.getElementById('soldBySelect').value;
                
                if (!accountId) {
                    showToast('‚ö†Ô∏è Please select an account', 'error');
                    return;
                }
                
                if (!profileNumber) {
                    showToast('‚ö†Ô∏è Please select a profile number', 'error');
                    return;
                }
                                // Validate buyer username and account email
                const buyerUsername = document.getElementById('buyerUsernameInput').value.trim();
                const accountEmail = document.getElementById('accountEmailInput').value.trim();
                
                if (!buyerUsername) {
                    showToast('‚ö†Ô∏è Please enter buyer username', 'error');
                    return;
                }
                
                if (!accountEmail) {
                    showToast('‚ö†Ô∏è Please enter account email', 'error');
                    return;
                }
                
                // Basic email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(accountEmail)) {
                    showToast('‚ö†Ô∏è Please enter a valid email address', 'error');
                    return;
                }
                if (!profileType) {
                    showToast('‚ö†Ô∏è Please select profile type (Solo or Shared)', 'error');
                    return;
                }
                
                if (!soldBy) {
                    showToast('‚ö†Ô∏è Please select who sold this', 'error');
                    return;
                }
                
                // Check for overselling - validate slot availability
                const maxSlots = profileType.value === 'Solo' ? 1 : 2;
                const existingSales = sales.filter(s => 
                    s.accountId === accountId && 
                    s.profileNumber === parseInt(profileNumber)
                );
                
                if (existingSales.length >= maxSlots) {
                    const soldByNames = existingSales.map(s => s.soldBy).join(', ');
                    showToast(`‚ùå This slot is already sold! All ${maxSlots} slots filled by: ${soldByNames}`, 'error');
                    return;
                }
                
                // Determine which slot number to use
                const usedSlots = existingSales.map(s => s.slotNumber).sort();
                let slotNumber = 1;
                for (let i = 1; i <= maxSlots; i++) {
                    if (!usedSlots.includes(i)) {
                        slotNumber = i;
                        break;
                    }
                }

                const profileName = document.getElementById('profileNameInput').value.trim() || null;

                const warrantyType = document.querySelector('input[name="warranty"]:checked');
                if (!warrantyType) {
                    showToast('‚ö†Ô∏è Please select warranty type (FW or NW)', 'error');
                    return;
                }

                const accountTypeSelection = document.querySelector('input[name="accountType"]:checked');
                if (!accountTypeSelection) {
                    showToast('‚ö†Ô∏è Please select account type (Solo or Shared)', 'error');
                    return;
                }

                const quantity = 1; // Always 1 for profile sales
                const price = parseFloat(document.getElementById('productPrice').textContent.replace('‚Ç±', ''));

                // Calculate commission based on who sold the slot
                const soldByUser = users.find(u => u.username === soldBy);
                const actualProfit = product.sellPrice - product.buyPrice;
                const sellerIsOwner = soldByUser ? soldByUser.role === 'owner' : currentSession.role === 'owner';
                const commissionRate = sellerIsOwner ? 100 : getCommissionRateForProfit(actualProfit);
                const commissionAmount = sellerIsOwner ? actualProfit : (actualProfit * commissionRate) / 100;
                const ownerProfit = actualProfit - commissionAmount;

                const timestamp = Date.now();
                const saleOwnerUsername = soldBy || currentSession.username;
                const saleOwner = users.find(u => u.username === saleOwnerUsername) || currentSession;

                const newSale = {
                    id: timestamp,
                    userId: saleOwner.id || currentSession.id,
                    userName: saleOwner.customName || saleOwner.username || currentSession.customName,
                    productId: productId,
                    productName: product.name,
                    accountId: accountId,
                    profileNumber: parseInt(profileNumber),
                    profileName: profileName,
                    profileType: profileType.value,
                    slotNumber: slotNumber,
                    soldBy: saleOwnerUsername,
                    recordedBy: currentSession.username,
                    buyerUsername: document.getElementById('buyerUsernameInput').value,
                    accountEmail: document.getElementById('accountEmailInput').value,
                    warranty: warrantyType.value,
                    accountType: accountTypeSelection.value,
                    quantity: quantity,
                    price: price,
                    buyPrice: product.buyPrice,
                    sellPrice: product.sellPrice,
                    commission: commissionAmount,
                    ownerProfit: ownerProfit,
                    totalPrice: price * quantity,
                    totalCommission: commissionAmount * quantity,
                    sold: true,
                    date: new Date().toISOString().split('T')[0],
                    timestamp: timestamp
                };

                const userKey = saleOwnerUsername.replace(/[.#$/[\]]/g, '_');
                showSyncingIndicator();
                getRef('sales/' + userKey + '/' + newSale.id).set(newSale)
                    .then(() => {
                        document.getElementById('addSaleForm').reset();
                        document.getElementById('productDetailsCard').style.display = 'none';
                        document.getElementById('totalEarningsCard').style.display = 'none';
                        document.getElementById('profileStatusDisplay').style.display = 'none';
                        document.getElementById('profileTrackingFields').style.display = 'none';
                        showToast('‚úÖ Sale added successfully!', 'success');
                        autoCalculatePayouts();
                    })
                    .catch((error) => {
                        showToast('‚ùå Error: ' + error.message, 'error');
                    });

            } else {
                // Regular sale (non-streaming)
                const warrantyType = document.querySelector('input[name="warranty"]:checked');
                const accountType = document.querySelector('input[name="accountType"]:checked');
                
                if (!warrantyType) {
                    showToast('‚ö†Ô∏è Please select warranty type (FW or NW)', 'error');
                    return;
                }
                
                if (!accountType) {
                    showToast('‚ö†Ô∏è Please select account type (Solo or Shared)', 'error');
                    return;
                }
                                // Validate buyer username and account email for regular sales
                const buyerUsername = document.getElementById('buyerUsernameInput').value.trim();
                const accountEmail = document.getElementById('accountEmailInput').value.trim();
                
                if (!buyerUsername) {
                    showToast('‚ö†Ô∏è Please enter buyer username', 'error');
                    return;
                }
                
                if (!accountEmail) {
                    showToast('‚ö†Ô∏è Please enter account email', 'error');
                    return;
                }
                
                // Basic email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(accountEmail)) {
                    showToast('‚ö†Ô∏è Please enter a valid email address', 'error');
                    return;
                }
                
                const quantity = parseInt(document.getElementById('productQuantity').value);
                const price = parseFloat(document.getElementById('productPrice').textContent.replace('‚Ç±', ''));
                
                // Calculate profit first: Profit = Sales - Capital
                const actualProfit = product.sellPrice - product.buyPrice;
                
                // Use bracket-based commission for admins or 100% for owner
                const userCommissionPercent = currentSession.role === 'owner' ? 100 : getCommissionRateForProfit(actualProfit);
                
                // Calculate salary: Salary = Profit √ó Rate (%)
                const commissionAmount = (actualProfit * userCommissionPercent) / 100;
                const yourProfit = currentSession.role === 'owner' ? actualProfit : commissionAmount;
                
                const newSale = {
                    id: Date.now(),
                    userId: currentSession.id,
                    userName: currentSession.customName,
                    productId: productId,
                    productName: product.name,
                    buyerUsername: document.getElementById('buyerUsernameInput').value,
                    accountEmail: document.getElementById('accountEmailInput').value,
                    warranty: warrantyType.value,
                    accountType: accountType.value,
                    quantity: quantity,
                    price: price,
                    buyPrice: product.buyPrice,
                    sellPrice: product.sellPrice,
                    commission: yourProfit,
                    totalPrice: price * quantity,
                    totalCommission: yourProfit * quantity,
                    sold: document.getElementById('productSoldStatus').value === 'yes',
                    date: new Date().toISOString().split('T')[0]
                };
                
                const userKey = currentSession.username.replace(/[.#$/[\]]/g, '_');
                showSyncingIndicator();
                getRef('sales/' + userKey + '/' + newSale.id).set(newSale)
                    .then(() => {
                        document.getElementById('addSaleForm').reset();
                        document.getElementById('buyerUsernameInput').value = '';
                        document.getElementById('accountEmailInput').value = '';
                        document.getElementById('productDetailsCard').style.display = 'none';
                        document.getElementById('totalEarningsCard').style.display = 'none';
                        showToast('‚úÖ Sale added successfully!', 'success');
                        autoCalculatePayouts();
                    })
                    .catch((error) => {
                        showToast('‚ùå Error: ' + error.message, 'error');
                    });
            }
        });

        // =================== ACCOUNT MANAGEMENT ===================
        
        function openAccountManagementModal() {
            document.getElementById('accountManagementModal').classList.add('show');
        }
        
        function closeAccountManagementModal() {
            document.getElementById('accountManagementModal').classList.remove('show');
            document.getElementById('createAccountForm').reset();
        }
        
        function saveAccount(event) {
            event.preventDefault();

            const accountId = document.getElementById('accountIdInput').value.trim();
            const status = document.getElementById('accountStatus').value || 'stock';
            const product = document.getElementById('accountProductSelect').value;
            const totalProfiles = parseInt(document.getElementById('accountProfilesInput').value);
            const profileType = document.querySelector('input[name="accountProfileType"]:checked').value;
            const slotsPerProfile = profileType === 'solo' ? 1 : 2;

            if (!accountId) {
                showToast('‚ö†Ô∏è Please enter an account ID', 'error');
                return;
            }

            // Check if account ID already exists
            const existingAccount = accounts.find(a => a.id === accountId);
            if (existingAccount) {
                showToast('‚ùå Account ID already exists!', 'error');
                return;
            }

            const newAccount = {
                id: accountId,
                status: status,
                product: product,
                totalProfiles: totalProfiles,
                profileType: profileType,
                slotsPerProfile: slotsPerProfile,
                createdDate: new Date().toISOString().split('T')[0],
                createdBy: currentSession.username
            };
            
            showSyncingIndicator();
            getRef('accounts/' + accountId).set(newAccount)
                .then(() => {
                    closeAccountManagementModal();
                    showToast('‚úÖ Account created successfully!', 'success');
                    renderInventoryDashboard();
                })
                .catch((error) => {
                    showToast('‚ùå Error: ' + error.message, 'error');
                });
        }
        
        function renderInventoryDashboard() {
            const accountsList = document.getElementById('accountsList');
            
            if (accounts.length === 0) {
                accountsList.innerHTML = '<div class="empty-state"><div class="empty-icon">üì¶</div><p>No accounts yet. Create your first account!</p></div>';
                return;
            }
            
            accountsList.innerHTML = accounts.map(account => {
                // Calculate statistics for this account
                const accountSales = sales.filter(s => s.accountId === account.id);
                const totalRevenue = accountSales.reduce((sum, s) => sum + s.totalPrice, 0);
                const totalCommissions = accountSales.reduce((sum, s) => sum + (s.commission * s.quantity), 0);
                const accountStatus = (account.status || 'stock');
                const statusLabel = accountStatus === 'sold' ? 'Sold' : 'Stock';
                const statusColor = accountStatus === 'sold' ? 'var(--danger)' : 'var(--success)';
                const statusBg = accountStatus === 'sold' ? 'rgba(239, 68, 68, 0.15)' : 'rgba(16, 185, 129, 0.15)';

                // Build profile status
                let profilesHTML = '';
                for (let i = 1; i <= account.totalProfiles; i++) {
                    const profileSales = accountSales.filter(s => s.profileNumber === i);
                    const filledSlots = profileSales.length;
                    const maxSlots = account.slotsPerProfile;
                    
                    let statusIcon = '';
                    let statusColor = '';
                    let borderColor = '';
                    
                    if (filledSlots === 0) {
                        statusIcon = '‚úÖ';
                        statusColor = 'var(--success)';
                        borderColor = 'var(--success)';
                    } else if (filledSlots < maxSlots) {
                        statusIcon = '‚ö†Ô∏è';
                        statusColor = 'var(--warning)';
                        borderColor = 'var(--warning)';
                    } else {
                        statusIcon = 'üî¥';
                        statusColor = 'var(--danger)';
                        borderColor = 'var(--danger)';
                    }
                    
                    let slotsHTML = '';
                    for (let slot = 1; slot <= maxSlots; slot++) {
                        const slotSale = profileSales.find(s => s.slotNumber === slot);
                        if (slotSale) {
                            slotsHTML += `<div style="font-size: 0.85em; margin-left: 20px;">‚Ä¢ Slot ${slot}: ‚úÖ SOLD by ${slotSale.soldBy} (${slotSale.date})</div>`;
                        } else {
                            slotsHTML += `<div style="font-size: 0.85em; margin-left: 20px;">‚Ä¢ Slot ${slot}: üü¢ AVAILABLE</div>`;
                        }
                    }
                    
                    profilesHTML += `
                        <div style="background: var(--light); padding: 15px; border-radius: 15px; border: 3px solid ${borderColor}; margin-bottom: 10px;">
                            <div style="font-weight: 700; color: var(--text-color); margin-bottom: 5px;">
                                ${statusIcon} Profile ${i}: ${filledSlots}/${maxSlots} slots filled
                            </div>
                            ${slotsHTML}
                            ${profileSales.length > 0 && profileSales[0].profileName ? `<div style="font-size: 0.85em; margin-top: 5px; opacity: 0.8;">Name: ${profileSales[0].profileName}</div>` : ''}
                        </div>
                    `;
                }
                
                return `
                    <div class="product-item">
                        <div class="product-item-header">
                            <div class="product-item-name">üé¨ ${account.id} - ${account.product}</div>
                            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                                <span class="inventory-status-badge" style="color: ${statusColor}; border-color: ${statusColor}; background: ${statusBg};">${statusLabel}</span>
                                ${currentSession.role === 'owner' ? `<button class="action-btn delete-btn" onclick="deleteAccount('${account.id}')">üóëÔ∏è Delete</button>` : ''}
                            </div>
                        </div>
                        <div class="product-item-details">
                            <div class="product-detail">
                                <div class="product-detail-label">üìä Total Profiles</div>
                                <div class="product-detail-value">${account.totalProfiles}</div>
                            </div>
                            <div class="product-detail">
                                <div class="product-detail-label">üë• Profile Type</div>
                                <div class="product-detail-value">${account.profileType} (${account.slotsPerProfile} per profile)</div>
                            </div>
                            <div class="product-detail">
                                <div class="product-detail-label">üí∞ Total Revenue</div>
                                <div class="product-detail-value">‚Ç±${totalRevenue.toFixed(2)}</div>
                            </div>
                            <div class="product-detail">
                                <div class="product-detail-label">üéØ Total Commissions</div>
                                <div class="product-detail-value">‚Ç±${totalCommissions.toFixed(2)}</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <h4 style="color: var(--primary); margin-bottom: 15px; font-weight: 700;">Profile Status</h4>
                            ${profilesHTML}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function deleteAccount(accountId) {
            if (!confirm('Delete this account? All associated sales will remain but references will be broken.')) return;
            
            showSyncingIndicator();
            getRef('accounts/' + accountId).remove()
                .then(() => {
                    showToast('üóëÔ∏è Account deleted', 'info');
                    renderInventoryDashboard();
                })
                .catch((error) => {
                    showToast('‚ùå Error: ' + error.message, 'error');
                });
        }

function deleteSale(id) {
    if (!confirm('Delete this sale?')) return;
    
    const sale = sales.find(s => s.id === id);
    if (!sale) return;
    
    // FIX: Use the same method as when adding sales
    const userKey = (sale.soldBy || currentSession.username).replace(/[.#$[\]]/g, '_');
    
    console.log('Deleting sale from path:', 'sales/' + userKey + '/' + id);
    
    getRef('sales/' + userKey + '/' + id).remove()
        .then(() => {
            showToast('üóëÔ∏è Sale deleted', 'info');
            autoCalculatePayouts();
        })
        .catch((error) => {
            console.error('Delete error:', error);
            showToast('‚ùå Error: ' + error.message, 'error');
        });
}

function editSale(id) {
    const sale = sales.find(s => s.id === id);
    if (!sale) return;
    
    document.getElementById('productSelect').value = sale.productId;
    displayProductDetails(sale.productId);
    document.querySelector(`input[name="warranty"][value="${sale.warranty}"]`).checked = true;
    document.querySelector(`input[name="accountType"][value="${sale.accountType}"]`).checked = true;
    document.getElementById('productQuantity').value = sale.quantity;
    document.getElementById('productSoldStatus').value = sale.sold ? 'yes' : 'no';
    document.getElementById('buyerUsernameInput').value = sale.buyerUsername || '';
    document.getElementById('accountEmailInput').value = sale.accountEmail || '';
    
    deleteSale(id, sale.userId);
    document.getElementById('addSaleForm').scrollIntoView({ behavior: 'smooth' });
    showToast('üìù Edit mode - Update and save', 'info');
}
        // =================== USER MANAGEMENT ===================
        document.getElementById('addUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value.trim();
            
            getRef('users/' + username).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        showToast('‚ùå Username already exists!', 'error');
                        return Promise.reject('Username exists');
                    }

                    const commissionMode = document.querySelector('input[name="commissionMode"]:checked').value;
                    const profitPercent = commissionMode === 'flatRate' 
                        ? parseFloat(document.getElementById('newProfitPercent').value) 
                        : 0; // Default to 0 for bracket-based, will use brackets
                    
                    const newUser = {
                        id: Date.now(),
                        customName: document.getElementById('newUserName').value.trim(),
                        username: username,
                        password: document.getElementById('newPassword').value,
                        role: 'admin',
                        commissionMode: commissionMode, // 'flatRate' or 'bracket'
                        profitPercent: profitPercent, // Only used if flatRate
                        createdDate: new Date().toISOString().split('T')[0]
                    };

                    showSyncingIndicator();
                    return getRef('users/' + username).set(newUser);
                })
                .then(() => {
                    document.getElementById('addUserForm').reset();
                    renderUserList();
                    showToast('‚úÖ Admin added successfully!', 'success');
                })
                .catch((error) => {
                    if (error !== 'Username exists') {
                        showToast('‚ùå Error: ' + error.message, 'error');
                    }
                });
        });

        function deleteUser(userId) {
            if (confirm('Delete this admin? Their sales will remain.')) {
                const user = users.find(u => u.id === userId);
                if (!user) return;
                
                showSyncingIndicator();
                getRef('users/' + user.username).remove()
                    .then(() => {
                        return getRef('payouts').orderByChild('userId').equalTo(userId).once('value');
                    })
                    .then((snapshot) => {
                        const deletePromises = [];
                        snapshot.forEach((child) => {
                            deletePromises.push(getRef('payouts/' + child.key).remove());
                        });
                        return Promise.all(deletePromises);
                    })
                    .then(() => {
                        renderUserList();
                        showToast('üóëÔ∏è Admin deleted', 'info');
                    })
                    .catch((error) => {
                        showToast('‚ùå Error: ' + error.message, 'error');
                    });
            }
        }

        function renderUserList() {
            const userList = document.getElementById('userList');
            const adminUsers = users.filter(u => u.role === 'admin');
            
            if (adminUsers.length === 0) {
                userList.innerHTML = '<div class="empty-state"><div class="empty-icon">üë•</div><p>No admins yet</p></div>';
                return;
            }
            
            userList.innerHTML = adminUsers.map(user => {
                const userSales = sales.filter(s => s.userId === user.id && s.sold);
                const totalCommission = userSales.reduce((sum, s) => sum + ((s.commission || 0) * s.quantity), 0);
                
                // Display commission info based on mode
                const commissionMode = user.commissionMode || 'flatRate'; // Default to flatRate for backwards compatibility
                const commissionDisplay = commissionMode === 'flatRate' 
                    ? `Flat Rate: ${user.profitPercent}%` 
                    : 'Bracket-Based';
                
                return `
                    <div class="user-item">
                        <div class="user-item-info">
                            <div class="user-item-name">${user.customName}</div>
                            <div class="user-item-details">
                                @${user.username} ‚Ä¢ ${commissionDisplay} ‚Ä¢ Total Earnings: ‚Ç±${totalCommission.toFixed(2)}
                            </div>
                        </div>
                        <div class="user-item-actions">
                            <button class="action-btn edit-btn" onclick="openEditCommissionModal(${user.id})">‚öôÔ∏è Settings</button>
                            <button class="action-btn delete-btn" onclick="deleteUser(${user.id})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // =================== UI UPDATE ===================
        function updateUI() {
            updateStats();
            renderSalesTable();
            updateCharts();
        }

function getFilteredSales() {
    const activePeriod = document.querySelector('.period-tab.active').dataset.period;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    let filtered = [...sales]; // Create a copy of all sales
    
    console.log('üîç Initial sales count:', filtered.length);
    
    // User filtering
    if (currentSession.role === 'owner') {
        const selectedUserId = document.getElementById('userFilter').value;
        if (selectedUserId !== 'all') {
            filtered = filtered.filter(s => s.userId == selectedUserId); // Use loose equality
            console.log(`üë§ Filtered by user ${selectedUserId}:`, filtered.length);
        }
    } else {
        filtered = filtered.filter(s => s.userId === currentSession.id);
    }
    
    // Period filtering
    if (activePeriod === 'today') {
        filtered = filtered.filter(s => {
            const saleDate = new Date(s.date);
            saleDate.setHours(0, 0, 0, 0);
            return saleDate.getTime() === today.getTime();
        });
    } else if (activePeriod === 'week') {
        const weekAgo = new Date(today);
        weekAgo.setDate(today.getDate() - 7);
        filtered = filtered.filter(s => new Date(s.date) >= weekAgo);
    } else if (activePeriod === 'month') {
        const monthAgo = new Date(today);
        monthAgo.setMonth(today.getMonth() - 1);
        filtered = filtered.filter(s => new Date(s.date) >= monthAgo);
    }
    
    console.log('‚úÖ Final filtered sales:', filtered.length);
    return filtered;
}

function calculateStats() {
    const filtered = getFilteredSales();
    
    console.log('üìä Calculating stats for', filtered.length, 'sales');
    
    // Initialize stats with proper defaults
    const stats = {
        totalSales: 0,
        totalCapital: 0,
        totalProducts: 0,
        soldCount: 0,
        totalProfit: 0,
        totalSalary: 0
    };

    // Calculate all metrics in a single pass
    filtered.forEach(sale => {
        // Ensure we have valid numbers
        const quantity = parseInt(sale.quantity) || 1;
        const price = parseFloat(sale.price) || 0;
        const buyPrice = parseFloat(sale.buyPrice) || 0;
        const sellPrice = parseFloat(sale.sellPrice) || price; // Fallback to price if sellPrice missing
        
        // Always add to total sales (price customer paid)
        stats.totalSales += (price * quantity);
        stats.totalProducts += quantity;
        
        if (sale.sold) {
            stats.soldCount += quantity;
            
            // Calculate capital (your cost) - use buyPrice if available, otherwise estimate
            const actualBuyPrice = buyPrice > 0 ? buyPrice : (sellPrice * 0.7); // Estimate 70% if buyPrice missing
            stats.totalCapital += (actualBuyPrice * quantity);
            
            // Calculate business profit (Sell Price - Buy Price)
            const profitPerUnit = sellPrice - actualBuyPrice;
            stats.totalProfit += (profitPerUnit * quantity);
        }
    });

    // Calculate Total Salary using bracket system
    const bracketRate = getCommissionRateForProfit(stats.totalProfit, currentSession.id);
    stats.totalSalary = (stats.totalProfit * bracketRate) / 100;

    // Calculate average sale value
    const avgSaleValue = stats.soldCount > 0 ? stats.totalSales / stats.soldCount : 0;
    
    const adminCount = users.filter(u => u.role === 'admin').length;
    
    // Update UI with proper formatting
    document.getElementById('totalSales').textContent = '‚Ç±' + stats.totalSales.toFixed(2);
    document.getElementById('totalCapital').textContent = '‚Ç±' + stats.totalCapital.toFixed(2);
    document.getElementById('totalProducts').textContent = stats.totalProducts;
    document.getElementById('soldCount').textContent = stats.soldCount;
    document.getElementById('totalProfit').textContent = '‚Ç±' + stats.totalProfit.toFixed(2);
    document.getElementById('totalSalary').textContent = '‚Ç±' + stats.totalSalary.toFixed(2);
    document.getElementById('avgSaleValue').textContent = '‚Ç±' + avgSaleValue.toFixed(2);
    document.getElementById('adminCount').textContent = adminCount;

    // Debug output
    console.log('üìà Final Stats:', stats);
    console.log('üí∞ Commission Rate:', bracketRate + '%');
}

        // =================== RENDER SALES TABLE ===================
        function renderSalesTable() {
            const tbody = document.getElementById('salesTableBody');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activeFilter = document.querySelector('.filter-btn.active').id;
            
            let filtered = getFilteredSales();
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(s => 
                    s.productName.toLowerCase().includes(searchTerm) ||
                    s.userName.toLowerCase().includes(searchTerm) ||
                    s.warranty.toLowerCase().includes(searchTerm) ||
                    s.accountType.toLowerCase().includes(searchTerm) ||
                    (s.buyerUsername && s.buyerUsername.toLowerCase().includes(searchTerm)) ||
                    (s.accountEmail && s.accountEmail.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply status filter
            if (activeFilter === 'filterSold') {
                filtered = filtered.filter(s => s.sold);
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="17">
                            <div class="empty-state">
                                <div class="empty-icon">üì¶</div>
                                <h3>No sales found</h3>
                                <p>Try adjusting your filters</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filtered.map(sale => {
                const warrantyClass = sale.warranty === 'FW' ? 'fw' : 'nw';
                const accountClass = sale.accountType === 'Solo' ? 'solo' : 'shared';
                const soldIcon = sale.sold ? '‚úÖ' : 'üì¶';
                
                // Format profile tracking columns
                const accountId = sale.accountId || '-';
                const profileNumber = sale.profileNumber ? `Profile ${sale.profileNumber}` : '-';
                const slotNumber = sale.slotNumber ? `${sale.slotNumber}/${sale.profileType === 'Solo' ? '1' : '2'}` : '-';
                const profileName = sale.profileName || '-';
                const soldBy = sale.soldBy || sale.userName || '-';
                
// In renderSalesTable() function, update the table row:
return `
    <tr data-sale-id="${sale.id}">
        <td>${sale.date}</td>
        ${currentSession.role === 'owner' ? `<td>${sale.userName}</td>` : ''}
        <td>${sale.productName}</td>
        <td>${sale.buyerUsername || '-'}</td>
        <td>${sale.accountEmail || '-'}</td>
        <td>${accountId}</td>
        <td>${profileNumber}</td>
        <td>${slotNumber}</td>
        <td>${profileName}</td>
        <td>${soldBy}</td>
        <td><span class="warranty-badge ${warrantyClass}">${sale.warranty}</span></td>
        <td><span class="account-type-badge ${accountClass}">${sale.accountType}</span></td>
        <td>${sale.quantity}</td>
        <td class="amount-cell">‚Ç±${sale.price.toFixed(2)}</td>
        <td class="amount-cell">‚Ç±${sale.totalPrice.toFixed(2)}</td>
        <td><span class="sold-check">‚úÖ</span></td>
        <td>
            <button class="action-btn edit-btn" onclick="editSale(${sale.id})">‚úèÔ∏è</button>
            <button class="action-btn delete-btn" onclick="deleteSale('${sale.id}', '${sale.userId}')">üóëÔ∏è</button>
        </td>
    </tr>
`;
            }).join('');
        }

        // =================== CHARTS ===================
        let salesChart, revenueChart;

        function updateCharts() {
            const filtered = getFilteredSales();
            
            // Sales Chart
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            if (salesChart) salesChart.destroy();
            
            salesChart = new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Sales',
                        data: [12, 19, 15, 25],
                        borderColor: '#8B5CF6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            if (revenueChart) revenueChart.destroy();
            
            revenueChart = new Chart(revenueCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Sold'],
                    datasets: [{
                        data: [
                            filtered.filter(s => s.sold).length,
                        ],
                        backgroundColor: ['#10B981']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });
        }

        // =================== PAYOUT MANAGEMENT ===================
        let currentPayoutPeriod = 'all';

        function openPayoutModal() {
            document.getElementById('payoutModal').classList.add('show');
            renderPayoutList();
        }

        function closePayoutModal() {
            document.getElementById('payoutModal').classList.remove('show');
        }

        function setPayoutPeriod(period) {
            currentPayoutPeriod = period;
            
            // Update button states
            document.querySelectorAll('#payoutPeriodAll, #payoutPeriodWeek, #payoutPeriodMonth').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('payoutPeriod' + period.charAt(0).toUpperCase() + period.slice(1)).classList.add('active');
            
            autoCalculatePayouts();
        }

        function renderPayoutList() {
            const payoutList = document.getElementById('payoutList');
            
            if (payouts.length === 0) {
                payoutList.innerHTML = '<div class="empty-state"><div class="empty-icon">üí∞</div><p>No payouts yet</p></div>';
                return;
            }
            
            // Filter payouts based on current period
            const now = new Date();
            let filteredPayouts = payouts.filter(p => p.status === 'pending');
            
            payoutList.innerHTML = filteredPayouts.map(payout => {
                const user = users.find(u => u.id === payout.userId);
                if (!user) return '';
                
                // Get sales for this user in the current period
                let userSales = sales.filter(s => s.userId === user.id && s.sold);
                
                if (currentPayoutPeriod === 'week') {
                    const weekAgo = new Date(now);
                    weekAgo.setDate(now.getDate() - 7);
                    userSales = userSales.filter(s => new Date(s.date) >= weekAgo);
                } else if (currentPayoutPeriod === 'month') {
                    const monthAgo = new Date(now);
                    monthAgo.setMonth(now.getMonth() - 1);
                    userSales = userSales.filter(s => new Date(s.date) >= monthAgo);
                }
                
                const salesCount = userSales.length;
                const totalProfit = userSales.reduce((sum, s) => sum + ((s.price - s.buyPrice) * s.quantity), 0);
                const commission = userSales.reduce((sum, s) => sum + ((s.commission || 0) * s.quantity), 0);
                
                // Calculate default vs custom commission breakdown
                const defaultCommission = userSales.filter(s => !s.customCommission).reduce((sum, s) => sum + ((s.commission || 0) * s.quantity), 0);
                const customCommissionTotal = userSales.filter(s => s.customCommission).reduce((sum, s) => sum + ((s.commission || 0) * s.quantity), 0);
                
                // Calculate average commission rate for display
                const avgRate = totalProfit > 0 ? ((commission / totalProfit) * 100).toFixed(1) : 0;
                
                return `
                    <div class="payout-item ${payout.status}">
                        <div class="payout-info" style="flex: 1;">
                            <div class="payout-admin">üë§ ${user.customName}</div>
                            <div class="payout-details">
                                Sales: ${salesCount} items | Profit Generated: ‚Ç±${totalProfit.toFixed(2)} | Avg Rate: ${avgRate}%
                            </div>
                            <div class="payout-breakdown" style="font-size: 0.85em; color: var(--text-color); opacity: 0.7; margin-top: 5px;">
                                üí° Commission calculated using bracket system based on profit ranges
                            </div>
                        </div>
                        <div class="payout-amount">üí∞ ‚Ç±${commission.toFixed(2)}</div>
                        <span class="payout-status ${payout.status}">${payout.status}</span>
                        ${payout.status === 'pending' ? `
                            <button class="action-btn edit-btn" onclick="openMarkPaidModal(${payout.id}, ${user.id}, ${commission})">
                                ‚úÖ Mark as Paid
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            if (filteredPayouts.length === 0) {
                payoutList.innerHTML = '<div class="empty-state"><div class="empty-icon">üí∞</div><p>No pending payouts</p></div>';
            }
        }

        function openMarkPaidModal(payoutId, userId, amount) {
            document.getElementById('payoutToMarkId').value = payoutId;
            document.getElementById('payoutToMarkUserId').value = userId;
            document.getElementById('payoutToMarkAmount').value = amount;
            document.getElementById('markPaidModal').classList.add('show');
        }

        function closeMarkPaidModal() {
            document.getElementById('markPaidModal').classList.remove('show');
            document.getElementById('markPaidForm').reset();
        }

        function confirmMarkAsPaid(event) {
            event.preventDefault();
            
            const payoutId = document.getElementById('payoutToMarkId').value;
            const userId = parseInt(document.getElementById('payoutToMarkUserId').value);
            const amount = parseFloat(document.getElementById('payoutToMarkAmount').value);
            const method = document.getElementById('paymentMethod').value;
            const reference = document.getElementById('paymentReference').value;
            const notes = document.getElementById('paymentNotes').value;
            
            // Create payout history record
            const historyRecord = {
                id: Date.now(),
                userId: userId,
                amount: amount,
                method: method,
                reference: reference || 'N/A',
                notes: notes || 'N/A',
                period: currentPayoutPeriod,
                paidDate: new Date().toISOString().split('T')[0],
                timestamp: Date.now()
            };
            
            // Save history record
            showSyncingIndicator();
            getRef('payoutHistory/' + historyRecord.id).set(historyRecord)
                .then(() => {
                    // Update payout status to paid
                    return getRef('payouts/' + payoutId).update({ 
                        status: 'paid',
                        paidDate: historyRecord.paidDate,
                        method: method,
                        reference: reference
                    });
                })
                .then(() => {
                    showToast('‚úÖ Payout marked as paid and saved to history!', 'success');
                    closeMarkPaidModal();
                    autoCalculatePayouts();
                })
                .catch((error) => {
                    showToast('‚ùå Error: ' + error.message, 'error');
                });
        }

        function openPayoutHistory() {
            document.getElementById('payoutHistoryModal').classList.add('show');
            loadPayoutHistory();
        }

        function closePayoutHistory() {
            document.getElementById('payoutHistoryModal').classList.remove('show');
        }

        function loadPayoutHistory() {
            getRef('payoutHistory').once('value', (snapshot) => {
                const history = snapshot.val() || {};
                const historyArray = Object.values(history).sort((a, b) => b.timestamp - a.timestamp);
                
                const tbody = document.getElementById('payoutHistoryBody');
                
                if (historyArray.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7">
                                <div class="empty-state">
                                    <div class="empty-icon">üìú</div>
                                    <p>No payout history yet</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = historyArray.map(record => {
                    const user = users.find(u => u.id === record.userId);
                    if (!user) return '';
                    
                    return `
                        <tr>
                            <td>${record.paidDate}</td>
                            <td>${user.customName}</td>
                            <td>${record.period}</td>
                            <td>‚Ç±${record.amount.toFixed(2)}</td>
                            <td>${record.method}</td>
                            <td>${record.reference}</td>
                            <td>${record.notes}</td>
                        </tr>
                    `;
                }).join('');
            });
        }

        // =================== AUTO-CALCULATE PAYOUTS ===================
        function autoCalculatePayouts() {
            if (currentSession.role !== 'owner') return;
            
            const adminUsers = users.filter(u => u.role === 'admin');
            
            adminUsers.forEach(user => {
                const userSales = sales.filter(s => s.userId === user.id && s.sold);
                
                const totalCommission = userSales.reduce((sum, s) => {
                    return sum + ((s.commission || 0) * s.quantity);
                }, 0);
                
                if (totalCommission > 0) {
                    const existingPayout = payouts.find(p => p.userId === user.id && p.status === 'pending');
                    
                    if (existingPayout) {
                        getRef('payouts/' + existingPayout.id).update({
                            amount: totalCommission,
                            date: new Date().toISOString().split('T')[0]
                        });
                    } else {
                        const payout = {
                            id: Date.now() + user.id,
                            userId: user.id,
                            amount: totalCommission,
                            status: 'pending',
                            date: new Date().toISOString().split('T')[0]
                        };
                        getRef('payouts/' + payout.id).set(payout);
                    }
                }
            });
        }

        // =================== EXPORT CSV ===================
        function exportToCSV() {
            const filtered = getFilteredSales();
            
            let csv = 'Date,Admin,Product,Buyer Username,Account Email,Warranty,Type,Qty,Price,Total,Sold\n';
            
            filtered.forEach(sale => {
                csv += `${sale.date},${sale.userName},${sale.productName},${sale.buyerUsername || ''},${sale.accountEmail || ''},${sale.warranty},${sale.accountType},${sale.quantity},${sale.price},${sale.totalPrice},${sale.sold ? 'Yes' : 'No'}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sales_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            
            showToast('üì• CSV exported successfully!', 'success');
        }

        // =================== CLEAR ALL DATA ===================
        function clearAllData() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL sales data! Are you sure?')) return;
            if (!confirm('This action cannot be undone. Continue?')) return;
            
            const userKey = currentSession.username.replace(/[.#$/[\]]/g, '_');
            
            if (currentSession.role === 'owner') {
                getRef('sales').remove()
                    .then(() => {
                        showToast('‚úÖ All sales data cleared', 'success');
                    })
                    .catch((error) => {
                        showToast('‚ùå Error: ' + error.message, 'error');
                    });
            } else {
                getRef('sales/' + userKey).remove()
                    .then(() => {
                        showToast('‚úÖ Your sales data cleared', 'success');
                    })
                    .catch((error) => {
                        showToast('‚ùå Error: ' + error.message, 'error');
                    });
            }
        }

        // =================== CALCULATOR ===================
        function appendCalc(value) {
            if (calcValue === '0' && value !== '.') {
                calcValue = value;
            } else {
                calcValue += value;
            }
            document.getElementById('calcDisplay').textContent = calcValue;
        }

        function clearCalc() {
            calcValue = '0';
            document.getElementById('calcDisplay').textContent = calcValue;
        }

        function deleteCalc() {
            calcValue = calcValue.slice(0, -1);
            if (calcValue === '') calcValue = '0';
            document.getElementById('calcDisplay').textContent = calcValue;
        }

        function calculateCalc() {
            try {
                calcValue = eval(calcValue.replace('√ó', '*')).toString();
                document.getElementById('calcDisplay').textContent = calcValue;
            } catch (e) {
                calcValue = 'Error';
                document.getElementById('calcDisplay').textContent = calcValue;
                setTimeout(() => {
                    calcValue = '0';
                    document.getElementById('calcDisplay').textContent = calcValue;
                }, 1500);
            }
        }

        // =================== EVENT LISTENERS ===================
        function setupEventListeners() {
            console.log('‚öôÔ∏è Setting up event listeners...');
            
            document.querySelectorAll('.period-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    updateUI();
                });
            });
            
            document.getElementById('searchInput').addEventListener('input', renderSalesTable);
            document.getElementById('userFilter').addEventListener('change', updateUI);
            
            const filterButtons = ['filterAll', 'filterSold'];
            filterButtons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.addEventListener('click', function() {
                        filterButtons.forEach(id => {
                            const b = document.getElementById(id);
                            if (b) b.classList.remove('active');
                        });
                        this.classList.add('active');
                        renderSalesTable();
                    });
                }
            });
            
            // ‚úÖ FIXED: Added null checks for all button event listeners
            const btnUsers = document.getElementById('btnUsers');
            if (btnUsers) {
                btnUsers.addEventListener('click', () => {
                    document.getElementById('userModal').classList.add('show');
                    renderUserList();
                    renderPayoutList();
                });
            }
            
            const btnProducts = document.getElementById('btnProducts');
            if (btnProducts) {
                btnProducts.addEventListener('click', () => {
                    document.getElementById('productModal').classList.add('show');
                    renderProductList();
                });
            }
            
            const btnPayout = document.getElementById('btnPayout');
            if (btnPayout) {
                btnPayout.addEventListener('click', () => {
                    openPayoutModal();
                });
            }
            
            const btnCalculator = document.getElementById('btnCalculator');
            if (btnCalculator) {
                btnCalculator.addEventListener('click', () => {
                    document.getElementById('calculatorModal').classList.add('show');
                });
            }
            
            const btnTheme = document.getElementById('btnTheme');
            if (btnTheme) {
                btnTheme.addEventListener('click', () => {
                    const themes = ['theme-purple', 'theme-blue', 'theme-green', 'theme-pink', 'theme-orange'];
                    const currentIndex = themes.indexOf(settings.theme);
                    settings.theme = themes[(currentIndex + 1) % themes.length];
                    applySettings();
                    showSyncingIndicator();
                    getRef('settings/' + currentUsername).set(settings);
                    showToast('üé® Theme changed!', 'success');
                });
            }
            
            const btnSettings = document.getElementById('btnSettings');
            if (btnSettings) {
                btnSettings.addEventListener('click', () => {
                    document.getElementById('settingsModal').classList.add('show');
                });
            }
            
            const btnDark = document.getElementById('btnDark');
            if (btnDark) {
                btnDark.addEventListener('click', () => {
                    settings.darkMode = !settings.darkMode;
                    applySettings();
                    showSyncingIndicator();
                    getRef('settings/' + currentUsername).set(settings);
                    showToast(settings.darkMode ? 'üåô Dark mode enabled' : '‚òÄÔ∏è Light mode enabled', 'info');
                });
            }
            
            const toggleDarkMode = document.getElementById('toggleDarkMode');
            if (toggleDarkMode) {
                toggleDarkMode.addEventListener('click', () => {
                    settings.darkMode = !settings.darkMode;
                    applySettings();
                    showSyncingIndicator();
                    getRef('settings/' + currentUsername).set(settings);
                });
            }
            
            const btnLogout = document.getElementById('btnLogout');
            if (btnLogout) {
                btnLogout.addEventListener('click', () => {
                    if (confirm('Are you sure you want to logout?')) {
                        localStorage.removeItem('session');
                        window.location.href = 'index.html';
                    }
                });
            }
            
            const btnExport = document.getElementById('btnExport');
            if (btnExport) {
                btnExport.addEventListener('click', exportToCSV);
            }
            
            const btnClearAll = document.getElementById('btnClearAll');
            if (btnClearAll) {
                btnClearAll.addEventListener('click', clearAllData);
            }
            
            // Commission mode toggle for admin creation form
            const commissionModeRadios = document.querySelectorAll('input[name="commissionMode"]');
            commissionModeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const flatRateSection = document.getElementById('flatRateSection');
                    const bracketInfoSection = document.getElementById('bracketInfoSection');
                    
                    if (this.value === 'flatRate') {
                        flatRateSection.style.display = 'block';
                        bracketInfoSection.style.display = 'none';
                        document.getElementById('newProfitPercent').required = true;
                    } else {
                        flatRateSection.style.display = 'none';
                        bracketInfoSection.style.display = 'block';
                        document.getElementById('newProfitPercent').required = false;
                    }
                });
            });
            
            console.log('‚úÖ Event listeners setup complete');
        }

// =================== COMMISSION BRACKET FUNCTIONS ===================

// Load commission brackets
function loadCommissionBrackets() {
    getRef('settings/' + currentUsername + '/commissionBrackets').on('value', (snapshot) => {
        if (snapshot.exists()) {
            commissionBrackets = snapshot.val();
            // Convert object to array and sort by minProfit
            if (!Array.isArray(commissionBrackets)) {
                commissionBrackets = Object.values(commissionBrackets);
            }
            commissionBrackets.sort((a, b) => a.minProfit - b.minProfit);
        } else {
            // Set default brackets if none exist
            commissionBrackets = [
                { id: 1, minProfit: 0, maxProfit: 299.99, rate: 10 },
                { id: 2, minProfit: 300, maxProfit: 599.99, rate: 15 },
                { id: 3, minProfit: 600, maxProfit: 999.99, rate: 20 },
                { id: 4, minProfit: 1000, maxProfit: null, rate: 25 }
            ];
            // Save defaults
            if (currentSession.role === 'owner') {
                saveCommissionBrackets();
            }
        }
        renderCommissionBrackets();
    });
}

// Save commission brackets
function saveCommissionBrackets() {
    if (currentSession.role !== 'owner') return;
    
    showSyncingIndicator();
    getRef('settings/' + currentUsername + '/commissionBrackets').set(commissionBrackets)
        .then(() => {
            console.log('‚úÖ Commission brackets saved');
        })
        .catch((error) => {
            showToast('‚ùå Error saving brackets: ' + error.message, 'error');
        });
}

// Calculate commission rate based on profit and brackets
function getCommissionRateForProfit(profit, userId = null) {
    // Determine which user's commission mode to check
    const user = userId ? users.find(u => u.id === userId) : currentSession;
    
    // If user has flat rate commission mode, use profitPercent
    if (user && user.commissionMode === 'flatRate') {
        return user.profitPercent || 20;
    }
    
    // Otherwise use bracket-based system
    // If brackets system is disabled or empty, use admin's default profitPercent
    if (!commissionBrackets || commissionBrackets.length === 0) {
        return user ? (user.profitPercent || 25) : 25;
    }
    
    // Find applicable bracket
    for (let bracket of commissionBrackets) {
        const min = bracket.minProfit || 0;
        const max = bracket.maxProfit;
        
        if (max === null || max === undefined) {
            // This is the "and above" bracket
            if (profit >= min) {
                return bracket.rate;
            }
        } else {
            // Standard bracket with min and max
            if (profit >= min && profit <= max) {
                return bracket.rate;
            }
        }
    }
    
    // Fallback to default if no bracket matches
    return user ? (user.profitPercent || 25) : 25;
}

// Render commission brackets list
function renderCommissionBrackets() {
    const list = document.getElementById('commissionBracketsList');
    if (!list) return;
    
    if (commissionBrackets.length === 0) {
        list.innerHTML = '<p style="color: var(--text-color); opacity: 0.6;">No brackets configured yet</p>';
        return;
    }
    
    list.innerHTML = commissionBrackets.map(bracket => {
        const maxDisplay = bracket.maxProfit !== null && bracket.maxProfit !== undefined 
            ? `‚Ç±${bracket.maxProfit.toFixed(2)}` 
            : 'and above';
        return `
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--light); border-radius: 10px; margin-bottom: 10px;">
                <div>
                    <strong>‚Ç±${bracket.minProfit.toFixed(2)} - ${maxDisplay}</strong>
                    <span style="margin-left: 15px; color: var(--primary); font-weight: 600;">
                        ${bracket.rate}% commission
                    </span>
                </div>
                <button class="action-btn delete-btn" onclick="deleteBracket(${bracket.id})" ${currentSession.role !== 'owner' ? 'disabled' : ''}>
                    üóëÔ∏è
                </button>
            </div>
        `;
    }).join('');
}

// Delete bracket
function deleteBracket(bracketId) {
    if (currentSession.role !== 'owner') {
        showToast('‚ùå Only owner can delete brackets', 'error');
        return;
    }
    
    if (!confirm('Delete this commission bracket?')) return;
    
    commissionBrackets = commissionBrackets.filter(b => b.id !== bracketId);
    saveCommissionBrackets();
    showToast('üóëÔ∏è Bracket deleted', 'info');
}

// Open bracket modal
function openAddBracketModal() {
    if (currentSession.role !== 'owner') {
        showToast('‚ùå Only owner can configure brackets', 'error');
        return;
    }
    document.getElementById('commissionBracketModal').classList.add('show');
}

// Close bracket modal
function closeCommissionBracketModal() {
    document.getElementById('commissionBracketModal').classList.remove('show');
    document.getElementById('addBracketForm').reset();
}

// Add bracket form handler
document.getElementById('addBracketForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (currentSession.role !== 'owner') {
        showToast('‚ùå Only owner can add brackets', 'error');
        return;
    }
    
    const minProfit = parseFloat(document.getElementById('bracketMinProfit').value);
    const maxProfitInput = document.getElementById('bracketMaxProfit').value;
    const maxProfit = maxProfitInput ? parseFloat(maxProfitInput) : null;
    const rate = parseFloat(document.getElementById('bracketRate').value);
    
    if (maxProfit !== null && minProfit >= maxProfit) {
        showToast('‚ö†Ô∏è Maximum profit must be greater than minimum', 'error');
        return;
    }
    
    const newBracket = {
        id: Date.now(),
        minProfit: minProfit,
        maxProfit: maxProfit,
        rate: rate
    };
    
    commissionBrackets.push(newBracket);
    commissionBrackets.sort((a, b) => a.minProfit - b.minProfit);
    
    saveCommissionBrackets();
    closeCommissionBracketModal();
    showToast('‚úÖ Bracket added successfully!', 'success');
});
        
        // Save brackets to Firebase
        function saveCommissionBrackets() {
            if (currentSession.role !== 'owner') return;
            
            showSyncingIndicator();
            getRef('settings/' + currentUsername + '/commissionBrackets').set(commissionBrackets)
                .catch((error) => {
                    showToast('‚ùå Error saving brackets: ' + error.message, 'error');
                });
        }
        
        // Delete bracket
        function deleteBracket(bracketId) {
            if (currentSession.role !== 'owner') {
                showToast('‚ùå Only owner can delete brackets', 'error');
                return;
            }
            
            if (!confirm('Delete this bracket?')) return;
            
            commissionBrackets = commissionBrackets.filter(b => b.id !== bracketId);
            saveCommissionBrackets();
            showToast('üóëÔ∏è Bracket deleted', 'info');
        }
        
        // =================== EDIT COMMISSION SETTINGS FUNCTIONS ===================
        
        function openEditCommissionModal(userId) {
            if (currentSession.role !== 'owner') {
                showToast('‚ùå Only owner can edit commission settings', 'error');
                return;
            }
            
            const user = users.find(u => u.id === userId);
            if (!user) {
                showToast('‚ùå User not found', 'error');
                return;
            }
            
            // Populate the form
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserName').value = user.customName;
            
            // Set commission mode (default to flatRate for backwards compatibility)
            const commissionMode = user.commissionMode || 'flatRate';
            document.getElementById(`editCommission${commissionMode === 'flatRate' ? 'FlatRate' : 'Bracket'}`).checked = true;
            
            // Set profit percent
            document.getElementById('editProfitPercent').value = user.profitPercent || 20;
            
            // Update form display based on mode
            updateEditCommissionFormDisplay(commissionMode);
            
            // Show modal
            document.getElementById('editCommissionModal').classList.add('show');
        }
        
        function closeEditCommissionModal() {
            document.getElementById('editCommissionModal').classList.remove('show');
            document.getElementById('editCommissionForm').reset();
        }
        
        function updateEditCommissionFormDisplay(mode) {
            const flatRateSection = document.getElementById('editFlatRateSection');
            const bracketInfoSection = document.getElementById('editBracketInfoSection');
            
            if (mode === 'flatRate') {
                flatRateSection.style.display = 'block';
                bracketInfoSection.style.display = 'none';
            } else {
                flatRateSection.style.display = 'none';
                bracketInfoSection.style.display = 'block';
            }
        }
        
        // Handle edit commission form submission
        document.getElementById('editCommissionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (currentSession.role !== 'owner') {
                showToast('‚ùå Only owner can edit commission settings', 'error');
                return;
            }
            
            const userId = parseInt(document.getElementById('editUserId').value);
            const user = users.find(u => u.id === userId);
            
            if (!user) {
                showToast('‚ùå User not found', 'error');
                return;
            }
            
            const commissionMode = document.querySelector('input[name="editCommissionMode"]:checked').value;
            const profitPercent = commissionMode === 'flatRate' 
                ? parseFloat(document.getElementById('editProfitPercent').value) 
                : (user.profitPercent || 0); // Keep existing value if switching to bracket
            
            // Update user object
            user.commissionMode = commissionMode;
            user.profitPercent = profitPercent;
            
            // Save to Firebase
            showSyncingIndicator();
            getRef('users/' + user.username).update({
                commissionMode: commissionMode,
                profitPercent: profitPercent
            })
            .then(() => {
                showToast('‚úÖ Commission settings updated!', 'success');
                closeEditCommissionModal();
                renderUserList();
            })
            .catch((error) => {
                showToast('‚ùå Error: ' + error.message, 'error');
            });
        });
        
        // Add event listener for commission mode toggle in edit form
        document.querySelectorAll('input[name="editCommissionMode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                updateEditCommissionFormDisplay(this.value);
            });
        });
        
        // =================== MODAL FUNCTIONS ===================
        function closeUserModal() {
            document.getElementById('userModal').classList.remove('show');
        }

function closeProductModal() {
    document.getElementById('productModal').classList.remove('show');
}

function closeUserModal() {
    document.getElementById('userModal').classList.remove('show');
}

function closeCalculatorModal() {
    document.getElementById('calculatorModal').classList.remove('show');
}

function closeSettingsModal() {
    document.getElementById('settingsModal').classList.remove('show');
}

function closePayoutModal() {
    document.getElementById('payoutModal').classList.remove('show');
}

function closeMarkPaidModal() {
    document.getElementById('markPaidModal').classList.remove('show');
    document.getElementById('markPaidForm').reset();
}

function closePayoutHistory() {
    document.getElementById('payoutHistoryModal').classList.remove('show');
}

function closeEditProductModal() {
    document.getElementById('editProductModal').classList.remove('show');
}

function closeAccountManagementModal() {
    document.getElementById('accountManagementModal').classList.remove('show');
    document.getElementById('createAccountForm').reset();
}

function closeThemeBuilder() {
    document.getElementById('themeBuilderModal').classList.remove('show');
}

function closeCommissionBracketModal() {
    document.getElementById('commissionBracketModal').classList.remove('show');
    document.getElementById('addBracketForm').reset();
}

function closeEditCommissionModal() {
    document.getElementById('editCommissionModal').classList.remove('show');
}

// Close modals when clicking outside
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('show');
        }
    });
});

// Close modals with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal.show').forEach(modal => {
            modal.classList.remove('show');
        });
    }
});

        // =================== THEME BUILDER FUNCTIONS ===================
        function toggleThemeBuilder() {
            document.getElementById('themeBuilderModal').classList.add('show');
        }

        function closeThemeBuilder() {
            document.getElementById('themeBuilderModal').classList.remove('show');
        }

        function applyCustomTheme() {
            const primary = document.getElementById('customPrimary').value;
            const secondary = document.getElementById('customSecondary').value;
            const success = document.getElementById('customSuccess').value;
            const danger = document.getElementById('customDanger').value;
            const warning = document.getElementById('customWarning').value;
            const info = document.getElementById('customInfo').value;
            const font = document.getElementById('customFont').value;
            const radius = document.getElementById('customRadius').value;
            const animation = document.getElementById('customAnimation').value;

            // Apply custom CSS variables
            document.documentElement.style.setProperty('--primary', primary);
            document.documentElement.style.setProperty('--secondary', secondary);
            document.documentElement.style.setProperty('--success', success);
            document.documentElement.style.setProperty('--danger', danger);
            document.documentElement.style.setProperty('--warning', warning);
            document.documentElement.style.setProperty('--info', info);
            document.documentElement.style.setProperty('--font-family', font);
            
            // Update border radius for all elements
            document.querySelectorAll('.card, .btn, input, select, textarea, .modal-content').forEach(el => {
                el.style.borderRadius = radius;
            });

            showToast('‚úÖ Custom theme applied!', 'success');
        }

        function saveCustomTheme() {
            const customTheme = {
                primary: document.getElementById('customPrimary').value,
                secondary: document.getElementById('customSecondary').value,
                success: document.getElementById('customSuccess').value,
                danger: document.getElementById('customDanger').value,
                warning: document.getElementById('customWarning').value,
                info: document.getElementById('customInfo').value,
                font: document.getElementById('customFont').value,
                radius: document.getElementById('customRadius').value,
                animation: document.getElementById('customAnimation').value
            };

            // Save to Firebase
            showSyncingIndicator();
            getRef('settings/' + currentUsername + '/customTheme').set(customTheme)
                .then(() => {
                    showToast('‚úÖ Custom theme saved!', 'success');
                    applyCustomTheme();
                })
                .catch((error) => {
                    showToast('‚ùå Error: ' + error.message, 'error');
                });
        }

        function exportTheme() {
            const customTheme = {
                primary: document.getElementById('customPrimary').value,
                secondary: document.getElementById('customSecondary').value,
                success: document.getElementById('customSuccess').value,
                danger: document.getElementById('customDanger').value,
                warning: document.getElementById('customWarning').value,
                info: document.getElementById('customInfo').value,
                font: document.getElementById('customFont').value,
                radius: document.getElementById('customRadius').value,
                animation: document.getElementById('customAnimation').value
            };

            const themeCode = btoa(JSON.stringify(customTheme));
            
            // Copy to clipboard
            navigator.clipboard.writeText(themeCode).then(() => {
                showToast('‚úÖ Theme code copied to clipboard!', 'success');
            }).catch(() => {
                prompt('Copy this theme code:', themeCode);
            });
        }

        function importTheme() {
            const themeCode = prompt('Enter theme code:');
            if (!themeCode) return;

            try {
                const customTheme = JSON.parse(atob(themeCode));
                
                document.getElementById('customPrimary').value = customTheme.primary;
                document.getElementById('customSecondary').value = customTheme.secondary;
                document.getElementById('customSuccess').value = customTheme.success;
                document.getElementById('customDanger').value = customTheme.danger;
                document.getElementById('customWarning').value = customTheme.warning;
                document.getElementById('customInfo').value = customTheme.info;
                document.getElementById('customFont').value = customTheme.font;
                document.getElementById('customRadius').value = customTheme.radius;
                document.getElementById('customAnimation').value = customTheme.animation;

                applyCustomTheme();
                showToast('‚úÖ Theme imported successfully!', 'success');
            } catch (error) {
                showToast('‚ùå Invalid theme code', 'error');
            }
        }

        function resetTheme() {
            document.getElementById('customPrimary').value = '#8B5CF6';
            document.getElementById('customSecondary').value = '#EC4899';
            document.getElementById('customSuccess').value = '#10B981';
            document.getElementById('customDanger').value = '#EF4444';
            document.getElementById('customWarning').value = '#F59E0B';
            document.getElementById('customInfo').value = '#3B82F6';
            document.getElementById('customFont').value = "'Poppins', sans-serif";
            document.getElementById('customRadius').value = '20px';
            document.getElementById('customAnimation').value = '0.3s';

            applyCustomTheme();
            showToast('‚úÖ Theme reset to default!', 'success');
        }

// =================== BULK SALES FUNCTIONS ===================
let bulkSalesRows = [];

function toggleBulkSales() {
    const bulkForm = document.getElementById('bulkSalesForm');
    const toggleBtn = document.getElementById('toggleBulkSales');
    
    if (bulkForm.style.display === 'none') {
        bulkForm.style.display = 'block';
        toggleBtn.textContent = 'üîº Hide Bulk Entry';
        toggleBtn.classList.add('active');
        
        // Initialize with 3 rows if empty
        if (bulkSalesRows.length === 0) {
            for (let i = 0; i < 3; i++) {
                addBulkRow();
            }
        }
    } else {
        bulkForm.style.display = 'none';
        toggleBtn.textContent = 'üìã Show Bulk Entry';
        toggleBtn.classList.remove('active');
    }
}

function addBulkRow() {
    const rowId = Date.now() + Math.random();
    bulkSalesRows.push(rowId);
    
    const tbody = document.getElementById('bulkSalesTableBody');
    const row = document.createElement('tr');
    row.id = `bulk-row-${rowId}`;
    
    // Build product options from available products
    let productOptions = '<option value="">-- Select --</option>';
    products.forEach(product => {
        productOptions += `<option value="${product.id}" data-buy="${product.buyPrice}" data-sell="${product.sellPrice}" data-account-type="${product.accountType}" data-warranty="${product.warranty}">${product.name}</option>`;
    });
    
    row.innerHTML = `
        <td>
            <select class="bulk-product" data-row="${rowId}" onchange="updateBulkRowDetails(${rowId})">
                ${productOptions}
            </select>
        </td>
        <td>
            <select class="bulk-account-type">
                <option value="Solo">Solo</option>
                <option value="Shared">Shared</option>
                <option value="Family">Family</option>
            </select>
        </td>
        <td>
            <select class="bulk-warranty">
                <option value="7 days">7 days</option>
                <option value="15 days">15 days</option>
                <option value="30 days">30 days</option>
                <option value="60 days">60 days</option>
                <option value="No Warranty">No Warranty</option>
            </select>
        </td>
        <td>
            <input type="text" class="bulk-username" placeholder="Buyer username">
        </td>
        <td>
            <input type="email" class="bulk-email" placeholder="Account email">
        </td>
        <td>
            <input type="number" class="bulk-buy" placeholder="0" min="0" step="0.01">
        </td>
        <td>
            <input type="number" class="bulk-sell" placeholder="0" min="0" step="0.01">
        </td>
        <td>
            <input type="number" class="bulk-qty" placeholder="1" min="1" value="1">
        </td>
        <td>
            <select class="bulk-status">
                <option value="no">In Stock</option>
                <option value="yes">Sold</option>
            </select>
        </td>
        <td>
            <button class="bulk-row-delete" onclick="removeBulkRow(${rowId})">‚úï</button>
        </td>
    `;
    
    tbody.appendChild(row);
    updateBulkRowCount();
}

function removeBulkRow(rowId) {
    bulkSalesRows = bulkSalesRows.filter(id => id !== rowId);
    document.getElementById(`bulk-row-${rowId}`).remove();
    updateBulkRowCount();
}

function updateBulkRowCount() {
    document.getElementById('bulkRowCount').textContent = `${bulkSalesRows.length} rows`;
}

function updateBulkRowDetails(rowId) {
    const row = document.getElementById(`bulk-row-${rowId}`);
    const productSelect = row.querySelector('.bulk-product');
    const selectedOption = productSelect.options[productSelect.selectedIndex];
    
    if (selectedOption.value) {
        const buyPrice = parseFloat(selectedOption.dataset.buy) || 0;
        const sellPrice = parseFloat(selectedOption.dataset.sell) || 0;
        const accountType = selectedOption.dataset.accountType || 'Solo';
        const warranty = selectedOption.dataset.warranty || '30 days';
        
        row.querySelector('.bulk-buy').value = buyPrice;
        row.querySelector('.bulk-sell').value = sellPrice;
        row.querySelector('.bulk-account-type').value = accountType;
        row.querySelector('.bulk-warranty').value = warranty;
    }
}

function applyToAllWarranty() {
    const firstRow = document.querySelector('.bulk-warranty');
    if (!firstRow) return;
    
    const value = firstRow.value;
    document.querySelectorAll('.bulk-warranty').forEach(select => {
        select.value = value;
    });
    showToast('‚úÖ Warranty applied to all rows', 'success');
}

function applyToAllAccountType() {
    const firstRow = document.querySelector('.bulk-account-type');
    if (!firstRow) return;
    
    const value = firstRow.value;
    document.querySelectorAll('.bulk-account-type').forEach(select => {
        select.value = value;
    });
    showToast('‚úÖ Account type applied to all rows', 'success');
}

function applyToAllStatus() {
    const firstRow = document.querySelector('.bulk-status');
    if (!firstRow) return;
    
    const value = firstRow.value;
    document.querySelectorAll('.bulk-status').forEach(select => {
        select.value = value;
    });
    showToast('‚úÖ Status applied to all rows', 'success');
}

async function saveBulkSales() {
    if (bulkSalesRows.length === 0) {
        showToast('‚ö†Ô∏è No rows to save', 'error');
        return;
    }

    const rows = document.querySelectorAll('#bulkSalesTableBody tr');
    const salesToSave = [];
    const errors = [];

    rows.forEach((row, index) => {
        const productSelect = row.querySelector('.bulk-product');
        const accountType = row.querySelector('.bulk-account-type').value;
        const warranty = row.querySelector('.bulk-warranty').value;
        const username = row.querySelector('.bulk-username').value.trim();
        const email = row.querySelector('.bulk-email').value.trim();
        const buyPrice = parseFloat(row.querySelector('.bulk-buy').value) || 0;
        const sellPrice = parseFloat(row.querySelector('.bulk-sell').value) || 0;
        const qty = parseInt(row.querySelector('.bulk-qty').value) || 1;
        const status = row.querySelector('.bulk-status').value;

        // Validation
        if (!productSelect.value) {
            errors.push(`Row ${index + 1}: Product not selected`);
            row.style.backgroundColor = '#ffe6e6';
            return;
        }
        
        if (!username) {
            errors.push(`Row ${index + 1}: Buyer username required`);
            row.style.backgroundColor = '#ffe6e6';
            return;
        }
        
        if (buyPrice <= 0 || sellPrice <= 0) {
            errors.push(`Row ${index + 1}: Invalid prices`);
            row.style.backgroundColor = '#ffe6e6';
            return;
        }
        
        if (sellPrice <= buyPrice) {
            errors.push(`Row ${index + 1}: Sell price must be > buy price`);
            row.style.backgroundColor = '#ffe6e6';
            return;
        }

        const selectedProduct = products.find(p => p.id == productSelect.value);
        if (!selectedProduct) {
            errors.push(`Row ${index + 1}: Product not found`);
            row.style.backgroundColor = '#ffe6e6';
            return;
        }

        // Clear error highlighting
        row.style.backgroundColor = '';

        const commission = sellPrice - buyPrice;
        const totalCommission = commission * qty;

        salesToSave.push({
            id: Date.now() + index,
            userId: currentSession.id,
            userName: currentSession.customName,
            userRole: currentSession.role,
            createdBy: currentSession.id,
            product: selectedProduct.name,
            productId: selectedProduct.id,
            productName: selectedProduct.name,
            accountType: accountType,
            warranty: warranty,
            buyerUsername: username,
            accountEmail: email,
            quantity: qty,
            price: sellPrice,
            buyPrice: buyPrice,
            totalPrice: sellPrice * qty,
            commission: commission,
            totalCommission: totalCommission,
            sold: status === 'yes',
            date: new Date().toISOString().split('T')[0],
            timestamp: Date.now()
        });
    });

    if (errors.length > 0) {
        showToast(`‚ùå Errors found:\n${errors.slice(0, 3).join('\n')}${errors.length > 3 ? '\n...and ' + (errors.length - 3) + ' more' : ''}`, 'error');
        return;
    }

    if (salesToSave.length === 0) {
        showToast('‚ö†Ô∏è No valid sales to save', 'error');
        return;
    }

    // Show progress
    showToast(`‚è≥ Saving ${salesToSave.length} sales...`, 'info');

    try {
        // Save each sale to Firebase
        const savePromises = salesToSave.map(sale => {
            return getRef(`sales/${currentSession.id}/${sale.id}`).set(sale);
        });

        await Promise.all(savePromises);

        showToast(`‚úÖ Successfully added ${salesToSave.length} sales!`, 'success');
        
        // Clear bulk form
        bulkSalesRows = [];
        document.getElementById('bulkSalesTableBody').innerHTML = '';
        updateBulkRowCount();
        
        // Hide bulk form
        toggleBulkSales();
        
        // Refresh sales table
        updateUI();
    } catch (error) {
        showToast(`‚ùå Error saving sales: ${error.message}`, 'error');
    }
}

// =================== TOAST ===================
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const icon = document.getElementById('toastIcon');
    const msg = document.getElementById('toastMessage');
    
    const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        info: '‚ÑπÔ∏è'
    };
    
    icon.textContent = icons[type];
    msg.textContent = message;
    toast.className = 'toast ' + type + ' show';
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
